{"version":3,"file":"rx-collection.js","names":["HOOKS_WHEN","HOOKS_KEYS","hooksApplied","RxCollectionBase","database","name","schema","internalStorageInstance","instanceCreationOptions","migrationStrategies","methods","attachments","options","cacheReplacementPolicy","defaultCacheReplacementPolicy","statics","conflictHandler","defaultConflictHandler","storageInstance","timeouts","Set","incrementalWriteQueue","_incrementalUpsertQueues","Map","synced","hooks","_subs","_docCache","_queryCache","createQueryCache","$","_changeEventBuffer","onDestroy","destroyed","_applyHookFunctions","asRxCollection","prepare","getWrappedStorageInstance","jsonSchema","IncrementalWriteQueue","primaryPath","newData","oldData","beforeDocumentUpdateWrite","result","_runHooks","eventBulks$","pipe","filter","changeEventBulk","collectionName","mergeMap","events","createChangeEventBuffer","DocumentCache","cE","isLocal","docData","createNewRxDocument","storageToken","databaseStorageToken","subDocs","changeStream","subscribe","eventBulk","id","internal","map","ev","storageChangeEventToRxChangeEvent","databaseToken","token","checkpoint","context","$emit","push","conflictResultionTasks","task","input","then","output","resolveConflictResultionTask","PROMISE_RESOLVE_VOID","migrationNeeded","pluginMissing","getDataMigrator","migrate","batchSize","migratePromise","insert","json","useJson","fillObjectDataBeforeInsert","bulkInsert","writeResult","isError","error","throwIfIsStorageWriteError","insertResult","ensureNotFalsy","success","docsData","length","useDocs","useDocData","hasHooks","Promise","all","doc","docs","docsMap","insertRows","set","Object","assign","_attachments","_meta","getDefaultRxDocumentMeta","_rev","getDefaultRevision","_deleted","row","document","bulkWrite","results","successDocData","values","rxDocuments","writtenDocData","getCachedRxDocument","get","primary","bulkRemove","ids","findByIds","exec","rxDocumentMap","Array","from","forEach","rxDocument","data","toMutableJSON","removeDocs","writeDoc","flatClone","previous","successIds","keys","getFromMapOrThrow","bulkUpsert","insertData","useJsonByDocId","newRxError","ret","slice","status","collection","writeError","documentId","writeData","docDataInDb","documentInDb","incrementalModify","newDoc","updatedDocs","concat","upsert","incrementalUpsert","queue","_incrementalUpsertEnsureRxDocumentExists","wasInserted","inserted","_incrementalUpsertUpdate","find","queryObj","_getDefaultQuery","query","createRxQuery","findOne","selector","limit","isArray","newRxTypeError","count","mangoQuery","$in","exportJSON","importJSON","_exportedJSON","insertCRDT","_updateObj","syncGraphQL","_options","syncCouchDB","_syncOptions","syncP2P","syncFirestore","addHook","when","key","fun","parallel","includes","boundFun","bind","runName","series","getHooks","instance","tasks","hook","promiseSeries","_runHooksSync","promiseWait","time","res","timeout","setTimeout","add","destroy","PROMISE_RESOLVE_FALSE","clearTimeout","requestIdlePromise","fn","close","sub","unsubscribe","collections","runAsyncPluginHooks","remove","removeCollectionStorages","storage","internalStore","hashFunction","operation","colProto","getPrototypeOf","fnName","ucfirst","_innerDoc","rxCollection","docDataFromCache","getLatestDocumentDataIfExists","resolve","createRxCollection","autoMigrate","localDocuments","storageInstanceCreationParams","databaseInstanceToken","databaseName","multiInstance","password","runPluginHooks","createRxCollectionStorageInstance","entries","funName","defineProperty","version","creator","err","reject","isRxCollection","obj"],"sources":["../../src/rx-collection.ts"],"sourcesContent":["import {\n    filter,\n    mergeMap\n} from 'rxjs/operators';\n\nimport {\n    ucfirst,\n    flatClone,\n    promiseSeries,\n    pluginMissing,\n    ensureNotFalsy,\n    getFromMapOrThrow,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_VOID,\n    getDefaultRxDocumentMeta,\n    getDefaultRevision\n} from './plugins/utils';\nimport {\n    fillObjectDataBeforeInsert,\n    createRxCollectionStorageInstance,\n    removeCollectionStorages\n} from './rx-collection-helper';\nimport {\n    createRxQuery,\n    _getDefaultQuery\n} from './rx-query';\nimport {\n    newRxError,\n    newRxTypeError\n} from './rx-error';\nimport type {\n    DataMigrator\n} from './plugins/migration';\nimport {\n    DocumentCache\n} from './doc-cache';\nimport {\n    QueryCache,\n    createQueryCache,\n    defaultCacheReplacementPolicy\n} from './query-cache';\nimport {\n    ChangeEventBuffer,\n    createChangeEventBuffer\n} from './change-event-buffer';\nimport {\n    runAsyncPluginHooks,\n    runPluginHooks\n} from './hooks';\n\nimport {\n    Subscription,\n    Observable\n} from 'rxjs';\n\nimport type {\n    KeyFunctionMap,\n    MigrationState,\n    RxCollection,\n    RxDatabase,\n    RxQuery,\n    RxDocument,\n    SyncOptionsGraphQL,\n    RxDumpCollection,\n    RxDumpCollectionAny,\n    MangoQuery,\n    MangoQueryNoLimit,\n    RxCacheReplacementPolicy,\n    RxStorageWriteError,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxStorageInstanceCreationParams,\n    BulkWriteRow,\n    RxChangeEvent,\n    RxChangeEventInsert,\n    RxChangeEventUpdate,\n    RxChangeEventDelete,\n    RxStorageInstance,\n    CollectionsOfDatabase,\n    RxChangeEventBulk,\n    RxLocalDocumentData,\n    RxDocumentBase,\n    RxConflictHandler,\n    MaybePromise,\n    CRDTEntry,\n    MangoQuerySelectorAndIndex\n} from './types';\nimport type {\n    RxGraphQLReplicationState\n} from './plugins/replication-graphql';\nimport type {\n    RxCouchDBReplicationState,\n    SyncOptionsCouchDB\n} from './plugins/replication-couchdb';\nimport type {\n    SyncOptionsP2P,\n    RxP2PReplicationPool\n} from './plugins/replication-p2p';\nimport type {\n    RxFirestoreReplicationState,\n    SyncOptionsFirestore\n} from './plugins/replication-firestore';\n\nimport {\n    RxSchema\n} from './rx-schema';\n\nimport {\n    createNewRxDocument\n} from './rx-document-prototype-merge';\nimport {\n    getWrappedStorageInstance,\n    storageChangeEventToRxChangeEvent,\n    throwIfIsStorageWriteError,\n    WrappedRxStorageInstance\n} from './rx-storage-helper';\nimport { defaultConflictHandler } from './replication-protocol';\nimport { IncrementalWriteQueue } from './incremental-write';\nimport { beforeDocumentUpdateWrite } from './rx-document';\n\nconst HOOKS_WHEN = ['pre', 'post'] as const;\ntype HookWhenType = typeof HOOKS_WHEN[number];\nconst HOOKS_KEYS = ['insert', 'save', 'remove', 'create'] as const;\ntype HookKeyType = typeof HOOKS_KEYS[number];\nlet hooksApplied = false;\n\nexport class RxCollectionBase<\n    InstanceCreationOptions,\n    RxDocumentType = { [prop: string]: any; },\n    OrmMethods = {},\n    StaticMethods = { [key: string]: any; }\n> {\n\n\n    /**\n     * Stores all 'normal' documents\n     */\n    public storageInstance: WrappedRxStorageInstance<RxDocumentType, any, InstanceCreationOptions> = {} as any;\n    public readonly timeouts: Set<ReturnType<typeof setTimeout>> = new Set();\n    public incrementalWriteQueue: IncrementalWriteQueue<RxDocumentType> = {} as any;\n\n    constructor(\n        public database: RxDatabase<CollectionsOfDatabase, any, InstanceCreationOptions>,\n        public name: string,\n        public schema: RxSchema<RxDocumentType>,\n        public internalStorageInstance: RxStorageInstance<RxDocumentType, any, InstanceCreationOptions>,\n        public instanceCreationOptions: InstanceCreationOptions = {} as any,\n        public migrationStrategies: KeyFunctionMap = {},\n        public methods: KeyFunctionMap = {},\n        public attachments: KeyFunctionMap = {},\n        public options: any = {},\n        public cacheReplacementPolicy: RxCacheReplacementPolicy = defaultCacheReplacementPolicy,\n        public statics: KeyFunctionMap = {},\n        public conflictHandler: RxConflictHandler<RxDocumentType> = defaultConflictHandler\n    ) {\n        _applyHookFunctions(this.asRxCollection);\n    }\n\n    get insert$(): Observable<RxChangeEventInsert<RxDocumentType>> {\n        return this.$.pipe(\n            filter(cE => cE.operation === 'INSERT')\n        ) as any;\n    }\n    get update$(): Observable<RxChangeEventUpdate<RxDocumentType>> {\n        return this.$.pipe(\n            filter(cE => cE.operation === 'UPDATE')\n        ) as any;\n    }\n    get remove$(): Observable<RxChangeEventDelete<RxDocumentType>> {\n        return this.$.pipe(\n            filter(cE => cE.operation === 'DELETE')\n        ) as any;\n    }\n\n    public _incrementalUpsertQueues: Map<string, Promise<any>> = new Map();\n    // defaults\n    public synced: boolean = false;\n    public hooks: {\n        [key in HookKeyType]: {\n            [when in HookWhenType]: {\n                series: Function[];\n                parallel: Function[];\n            };\n        }\n    } = {} as any;\n    public _subs: Subscription[] = [];\n\n    public _docCache: DocumentCache<RxDocumentType, OrmMethods> = {} as any;\n\n    public _queryCache: QueryCache = createQueryCache();\n    public $: Observable<RxChangeEvent<RxDocumentType>> = {} as any;\n    public _changeEventBuffer: ChangeEventBuffer = {} as ChangeEventBuffer;\n\n\n\n    /**\n     * When the collection is destroyed,\n     * these functions will be called an awaited.\n     * Used to automatically clean up stuff that\n     * belongs to this collection.\n     */\n    public onDestroy: (() => MaybePromise<any>)[] = [];\n    public destroyed = false;\n\n    public async prepare(): Promise<void> {\n        this.storageInstance = getWrappedStorageInstance(\n            this.database,\n            this.internalStorageInstance,\n            this.schema.jsonSchema\n        );\n        this.incrementalWriteQueue = new IncrementalWriteQueue<RxDocumentType>(\n            this.storageInstance,\n            this.schema.primaryPath,\n            (newData, oldData) => beforeDocumentUpdateWrite(this as any, newData, oldData),\n            result => this._runHooks('post', 'save', result)\n        );\n\n        this.$ = this.database.eventBulks$.pipe(\n            filter(changeEventBulk => changeEventBulk.collectionName === this.name),\n            mergeMap(changeEventBulk => changeEventBulk.events),\n        );\n        this._changeEventBuffer = createChangeEventBuffer(this.asRxCollection);\n        this._docCache = new DocumentCache(\n            this.schema.primaryPath,\n            this.$.pipe(filter(cE => !cE.isLocal)),\n            docData => createNewRxDocument(this.asRxCollection, docData)\n        );\n\n        /**\n         * Instead of resolving the EventBulk array here and spit it into\n         * single events, we should fully work with event bulks internally\n         * to save performance.\n         */\n        const databaseStorageToken = await this.database.storageToken;\n        const subDocs = this.storageInstance.changeStream().subscribe(eventBulk => {\n            const changeEventBulk: RxChangeEventBulk<RxDocumentType | RxLocalDocumentData> = {\n                id: eventBulk.id,\n                internal: false,\n                collectionName: this.name,\n                storageToken: databaseStorageToken,\n                events: eventBulk.events.map(ev => storageChangeEventToRxChangeEvent(\n                    false,\n                    ev,\n                    this as any\n                )),\n                databaseToken: this.database.token,\n                checkpoint: eventBulk.checkpoint,\n                context: eventBulk.context\n            };\n            this.database.$emit(changeEventBulk);\n        });\n        this._subs.push(subDocs);\n\n        /**\n         * Resolve the conflict tasks\n         * of the RxStorageInstance\n         */\n        this._subs.push(\n            this.storageInstance\n                .conflictResultionTasks()\n                .subscribe(task => {\n                    this\n                        .conflictHandler(task.input, task.context)\n                        .then(output => {\n                            this.storageInstance.resolveConflictResultionTask({\n                                id: task.id,\n                                output\n                            });\n                        });\n                })\n        );\n\n        return PROMISE_RESOLVE_VOID;\n    }\n\n\n    // overwritte by migration-plugin\n    migrationNeeded(): Promise<boolean> {\n        throw pluginMissing('migration');\n    }\n    getDataMigrator(): DataMigrator {\n        throw pluginMissing('migration');\n    }\n    migrate(batchSize: number = 10): Observable<MigrationState> {\n        return this.getDataMigrator().migrate(batchSize);\n    }\n    migratePromise(batchSize: number = 10): Promise<any> {\n        return this.getDataMigrator().migratePromise(batchSize);\n    }\n\n    async insert(\n        json: RxDocumentType | RxDocument\n    ): Promise<RxDocument<RxDocumentType, OrmMethods>> {\n\n        // TODO do we need fillObjectDataBeforeInsert() here because it is also run at bulkInsert() later\n        const useJson: RxDocumentWriteData<RxDocumentType> = fillObjectDataBeforeInsert(this.schema, json);\n\n        const writeResult = await this.bulkInsert([useJson]);\n\n        const isError = writeResult.error[0];\n        throwIfIsStorageWriteError(this as any, useJson[this.schema.primaryPath] as any, json, isError);\n        const insertResult = ensureNotFalsy(writeResult.success[0]);\n        return insertResult;\n    }\n\n    async bulkInsert(\n        docsData: RxDocumentType[]\n    ): Promise<{\n        success: RxDocument<RxDocumentType, OrmMethods>[];\n        error: RxStorageWriteError<RxDocumentType>[];\n    }> {\n        /**\n         * Optimization shortcut,\n         * do nothing when called with an empty array\n         */\n        if (docsData.length === 0) {\n            return {\n                success: [],\n                error: []\n            };\n        }\n\n        const useDocs = docsData.map(docData => {\n            const useDocData = fillObjectDataBeforeInsert(this.schema, docData);\n            return useDocData;\n        });\n        const docs = this.hasHooks('pre', 'insert') ?\n            await Promise.all(\n                useDocs.map(doc => {\n                    return this._runHooks('pre', 'insert', doc)\n                        .then(() => {\n                            return doc;\n                        });\n                })\n            ) : useDocs;\n        const docsMap: Map<string, RxDocumentType> = new Map();\n        const insertRows: BulkWriteRow<RxDocumentType>[] = docs.map(doc => {\n            docsMap.set((doc as any)[this.schema.primaryPath] as any, doc);\n            const docData = Object.assign(doc, {\n                _attachments: {},\n                _meta: getDefaultRxDocumentMeta(),\n                _rev: getDefaultRevision(),\n                _deleted: false\n            });\n            const row: BulkWriteRow<RxDocumentType> = { document: docData };\n            return row;\n        });\n        const results = await this.storageInstance.bulkWrite(\n            insertRows,\n            'rx-collection-bulk-insert'\n        );\n\n        // create documents\n        const successDocData: RxDocumentData<RxDocumentType>[] = Object.values(results.success);\n        const rxDocuments: any[] = successDocData\n            .map((writtenDocData) => this._docCache.getCachedRxDocument(writtenDocData));\n\n        if (this.hasHooks('post', 'insert')) {\n            await Promise.all(\n                rxDocuments.map(doc => {\n                    return this._runHooks(\n                        'post', 'insert',\n                        docsMap.get(doc.primary),\n                        doc\n                    );\n                })\n            );\n        }\n\n        return {\n            success: rxDocuments,\n            error: Object.values(results.error)\n        };\n    }\n\n    async bulkRemove(\n        ids: string[]\n    ): Promise<{\n        success: RxDocument<RxDocumentType, OrmMethods>[];\n        error: RxStorageWriteError<RxDocumentType>[];\n    }> {\n        /**\n         * Optimization shortcut,\n         * do nothing when called with an empty array\n         */\n        if (ids.length === 0) {\n            return {\n                success: [],\n                error: []\n            };\n        }\n\n        const rxDocumentMap = await this.findByIds(ids).exec();\n        const docsData: RxDocumentData<RxDocumentType>[] = [];\n        const docsMap: Map<string, RxDocumentData<RxDocumentType>> = new Map();\n        Array.from(rxDocumentMap.values()).forEach(rxDocument => {\n            const data: RxDocumentData<RxDocumentType> = rxDocument.toMutableJSON(true) as any;\n            docsData.push(data);\n            docsMap.set(rxDocument.primary, data);\n        });\n\n        await Promise.all(\n            docsData.map(doc => {\n                const primary = (doc as any)[this.schema.primaryPath];\n                return this._runHooks('pre', 'remove', doc, rxDocumentMap.get(primary));\n            })\n        );\n        const removeDocs: BulkWriteRow<RxDocumentType>[] = docsData.map(doc => {\n            const writeDoc = flatClone(doc);\n            writeDoc._deleted = true;\n            return {\n                previous: doc,\n                document: writeDoc\n            };\n        });\n        const results = await this.storageInstance.bulkWrite(\n            removeDocs,\n            'rx-collection-bulk-remove'\n        );\n\n        const successIds: string[] = Object.keys(results.success);\n\n        // run hooks\n        await Promise.all(\n            successIds.map(id => {\n                return this._runHooks(\n                    'post',\n                    'remove',\n                    docsMap.get(id),\n                    rxDocumentMap.get(id)\n                );\n            })\n        );\n\n        const rxDocuments = successIds.map(id => getFromMapOrThrow(rxDocumentMap, id));\n\n        return {\n            success: rxDocuments,\n            error: Object.values(results.error)\n        };\n    }\n\n    /**\n     * same as bulkInsert but overwrites existing document with same primary\n     */\n    async bulkUpsert(docsData: Partial<RxDocumentType>[]): Promise<RxDocument<RxDocumentType, OrmMethods>[]> {\n        const insertData: RxDocumentType[] = [];\n        const useJsonByDocId: Map<string, RxDocumentType> = new Map();\n        docsData.forEach(docData => {\n            const useJson = fillObjectDataBeforeInsert(this.schema, docData);\n            const primary: string = useJson[this.schema.primaryPath] as any;\n            if (!primary) {\n                throw newRxError('COL3', {\n                    primaryPath: this.schema.primaryPath as string,\n                    data: useJson,\n                    schema: this.schema.jsonSchema\n                });\n            }\n            useJsonByDocId.set(primary, useJson);\n            insertData.push(useJson);\n        });\n\n        const insertResult = await this.bulkInsert(insertData);\n        let ret = insertResult.success.slice(0);\n        const updatedDocs = await Promise.all(\n            insertResult.error.map(async (error) => {\n                if (error.status !== 409) {\n                    throw newRxError('VD2', {\n                        collection: this.name,\n                        writeError: error\n                    });\n                }\n                const id = error.documentId;\n                const writeData = getFromMapOrThrow(useJsonByDocId, id);\n                const docDataInDb = ensureNotFalsy(error.documentInDb);\n                const doc = this._docCache.getCachedRxDocument(docDataInDb);\n                const newDoc = await doc.incrementalModify(() => writeData);\n                return newDoc;\n            })\n        );\n        ret = ret.concat(updatedDocs);\n        return ret;\n    }\n\n    /**\n     * same as insert but overwrites existing document with same primary\n     */\n    upsert(json: Partial<RxDocumentType>): Promise<RxDocument<RxDocumentType, OrmMethods>> {\n        return this.bulkUpsert([json]).then(result => result[0]);\n    }\n\n    /**\n     * upserts to a RxDocument, uses incrementalModify if document already exists\n     */\n    incrementalUpsert(json: Partial<RxDocumentType>): Promise<RxDocument<RxDocumentType, OrmMethods>> {\n        const useJson = fillObjectDataBeforeInsert(this.schema, json);\n        const primary: string = useJson[this.schema.primaryPath] as any;\n        if (!primary) {\n            throw newRxError('COL4', {\n                data: json\n            });\n        }\n\n        // ensure that it won't try 2 parallel runs\n        let queue = this._incrementalUpsertQueues.get(primary);\n        if (!queue) {\n            queue = PROMISE_RESOLVE_VOID;\n        }\n        queue = queue\n            .then(() => _incrementalUpsertEnsureRxDocumentExists(this as any, primary as any, useJson))\n            .then((wasInserted) => {\n                if (!wasInserted.inserted) {\n                    return _incrementalUpsertUpdate(wasInserted.doc, useJson);\n                } else {\n                    return wasInserted.doc;\n                }\n            });\n        this._incrementalUpsertQueues.set(primary, queue);\n        return queue;\n    }\n\n    find(queryObj?: MangoQuery<RxDocumentType>): RxQuery<\n        RxDocumentType,\n        RxDocument<RxDocumentType, OrmMethods>[]\n    > {\n        if (typeof queryObj === 'string') {\n            throw newRxError('COL5', {\n                queryObj\n            });\n        }\n\n        if (!queryObj) {\n            queryObj = _getDefaultQuery();\n        }\n\n        const query = createRxQuery('find', queryObj, this as any);\n        return query as any;\n    }\n\n    findOne(\n        queryObj?: MangoQueryNoLimit<RxDocumentType> | string\n    ): RxQuery<\n        RxDocumentType,\n        RxDocument<RxDocumentType, OrmMethods> | null\n    > {\n        let query;\n\n        if (typeof queryObj === 'string') {\n            query = createRxQuery('findOne', {\n                selector: {\n                    [this.schema.primaryPath]: queryObj\n                },\n                limit: 1\n            }, this as any);\n        } else {\n            if (!queryObj) {\n                queryObj = _getDefaultQuery();\n            }\n\n            // cannot have limit on findOne queries because it will be overwritte\n            if ((queryObj as MangoQuery).limit) {\n                throw newRxError('QU6');\n            }\n\n            (queryObj as any).limit = 1;\n            query = createRxQuery<RxDocumentType>('findOne', queryObj, this as any);\n        }\n\n        if (\n            typeof queryObj === 'number' ||\n            Array.isArray(queryObj)\n        ) {\n            throw newRxTypeError('COL6', {\n                queryObj\n            });\n        }\n\n        return query as any;\n    }\n\n    count(queryObj?: MangoQuerySelectorAndIndex<RxDocumentType>): RxQuery<\n        RxDocumentType,\n        number\n    > {\n        if (!queryObj) {\n            queryObj = _getDefaultQuery();\n        }\n        const query = createRxQuery('count', queryObj, this as any);\n        return query as any;\n    }\n\n    /**\n     * find a list documents by their primary key\n     * has way better performance then running multiple findOne() or a find() with a complex $or-selected\n     */\n    findByIds(\n        ids: string[]\n    ): RxQuery<RxDocumentType, Map<string, RxDocument<RxDocumentType, OrmMethods>>> {\n        const mangoQuery: MangoQuery<RxDocumentType> = {\n            selector: {\n                [this.schema.primaryPath]: {\n                    $in: ids.slice(0)\n                }\n            } as any\n        };\n        const query = createRxQuery('findByIds', mangoQuery, this as any);\n        return query as any;\n    }\n\n    /**\n     * Export collection to a JSON friendly format.\n     */\n    exportJSON(): Promise<RxDumpCollection<RxDocumentType>>;\n    exportJSON(): Promise<RxDumpCollectionAny<RxDocumentType>>;\n    exportJSON(): Promise<any> {\n        throw pluginMissing('json-dump');\n    }\n\n    /**\n     * Import the parsed JSON export into the collection.\n     * @param _exportedJSON The previously exported data from the `<collection>.exportJSON()` method.\n     */\n    importJSON(_exportedJSON: RxDumpCollectionAny<RxDocumentType>): Promise<void> {\n        throw pluginMissing('json-dump');\n    }\n\n    insertCRDT(_updateObj: CRDTEntry<any> | CRDTEntry<any>[]): RxDocument<RxDocumentType, OrmMethods> {\n        throw pluginMissing('crdt');\n    }\n\n    /**\n     * sync with a GraphQL endpoint\n     */\n    syncGraphQL<CheckpointType = any>(_options: SyncOptionsGraphQL<RxDocumentType, CheckpointType>): RxGraphQLReplicationState<RxDocumentType, CheckpointType> {\n        throw pluginMissing('replication-graphql');\n    }\n\n    syncCouchDB(_syncOptions: SyncOptionsCouchDB<RxDocumentType>): RxCouchDBReplicationState<RxDocumentType> {\n        throw pluginMissing('replication-couchdb');\n    }\n\n    syncP2P(_syncOptions: SyncOptionsP2P<RxDocumentType>): RxP2PReplicationPool<RxDocumentType> {\n        throw pluginMissing('replication-p2p');\n    }\n    syncFirestore(_syncOptions: SyncOptionsFirestore<RxDocumentType>): RxFirestoreReplicationState<RxDocumentType> {\n        throw pluginMissing('replication-firestore');\n    }\n\n\n    /**\n     * HOOKS\n     */\n    addHook(when: HookWhenType, key: HookKeyType, fun: any, parallel = false) {\n        if (typeof fun !== 'function') {\n            throw newRxTypeError('COL7', {\n                key,\n                when\n            });\n        }\n\n        if (!HOOKS_WHEN.includes(when)) {\n            throw newRxTypeError('COL8', {\n                key,\n                when\n            });\n        }\n\n        if (!HOOKS_KEYS.includes(key)) {\n            throw newRxError('COL9', {\n                key\n            });\n        }\n\n        if (when === 'post' && key === 'create' && parallel === true) {\n            throw newRxError('COL10', {\n                when,\n                key,\n                parallel\n            });\n        }\n\n        // bind this-scope to hook-function\n        const boundFun = fun.bind(this);\n\n        const runName = parallel ? 'parallel' : 'series';\n\n        this.hooks[key] = this.hooks[key] || {};\n        this.hooks[key][when] = this.hooks[key][when] || {\n            series: [],\n            parallel: []\n        };\n        this.hooks[key][when][runName].push(boundFun);\n    }\n\n    getHooks(when: HookWhenType, key: HookKeyType) {\n        if (\n            !this.hooks[key] ||\n            !this.hooks[key][when]\n        ) {\n            return {\n                series: [],\n                parallel: []\n            };\n        }\n        return this.hooks[key][when];\n    }\n\n    hasHooks(when: HookWhenType, key: HookKeyType) {\n        const hooks = this.getHooks(when, key);\n        if (!hooks) {\n            return false;\n        }\n        return hooks.series.length > 0 || hooks.parallel.length > 0;\n    }\n\n    _runHooks(when: HookWhenType, key: HookKeyType, data: any, instance?: any): Promise<any> {\n        const hooks = this.getHooks(when, key);\n\n        if (!hooks) {\n            return PROMISE_RESOLVE_VOID;\n        }\n\n        // run parallel: false\n        const tasks = hooks.series.map((hook: any) => () => hook(data, instance));\n        return promiseSeries(tasks)\n            // run parallel: true\n            .then(() => Promise.all(\n                hooks.parallel\n                    .map((hook: any) => hook(data, instance))\n            ));\n    }\n\n    /**\n     * does the same as ._runHooks() but with non-async-functions\n     */\n    _runHooksSync(when: HookWhenType, key: HookKeyType, data: any, instance: any) {\n        const hooks = this.getHooks(when, key);\n        if (!hooks) return;\n        hooks.series.forEach((hook: any) => hook(data, instance));\n    }\n\n    /**\n     * Returns a promise that resolves after the given time.\n     * Ensures that is properly cleans up when the collection is destroyed\n     * so that no running timeouts prevent the exit of the JavaScript process.\n     */\n    promiseWait(time: number): Promise<void> {\n        const ret = new Promise<void>(res => {\n            const timeout = setTimeout(() => {\n                this.timeouts.delete(timeout);\n                res();\n            }, time);\n            this.timeouts.add(timeout);\n        });\n        return ret;\n    }\n\n    destroy(): Promise<boolean> {\n        if (this.destroyed) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n\n        /**\n         * Settings destroyed = true\n         * must be the first thing to do,\n         * so for example the replication can directly stop\n         * instead of sending requests to a closed storage.\n         */\n        this.destroyed = true;\n\n\n        Array.from(this.timeouts).forEach(timeout => clearTimeout(timeout));\n        if (this._changeEventBuffer) {\n            this._changeEventBuffer.destroy();\n        }\n        /**\n         * First wait until the whole database is idle.\n         * This ensures that the storage does not get closed\n         * while some operation is running.\n         * It is important that we do not intercept a running call\n         * because it might lead to undefined behavior like when a doc is written\n         * but the change is not added to the changes collection.\n         */\n        return this.database.requestIdlePromise()\n            .then(() => Promise.all(this.onDestroy.map(fn => fn())))\n            .then(() => this.storageInstance.close())\n            .then(() => {\n                /**\n                 * Unsubscribing must be done AFTER the storageInstance.close()\n                 * Because the conflict handling is part of the subscriptions and\n                 * otherwise there might be open conflicts to be resolved which\n                 * will then stuck and never resolve.\n                 */\n                this._subs.forEach(sub => sub.unsubscribe());\n\n                delete this.database.collections[this.name];\n                return runAsyncPluginHooks('postDestroyRxCollection', this).then(() => true);\n            });\n    }\n\n    /**\n     * remove all data of the collection\n     */\n    async remove(): Promise<any> {\n        await this.destroy();\n        await removeCollectionStorages(\n            this.database.storage,\n            this.database.internalStore,\n            this.database.token,\n            this.database.name,\n            this.name,\n            this.database.hashFunction\n        );\n    }\n\n    get asRxCollection(): RxCollection<RxDocumentType, OrmMethods, StaticMethods> {\n        return this as any;\n    }\n}\n\n/**\n * adds the hook-functions to the collections prototype\n * this runs only once\n */\nfunction _applyHookFunctions(\n    collection: RxCollection<any, any>\n) {\n    if (hooksApplied) return; // already run\n    hooksApplied = true;\n    const colProto = Object.getPrototypeOf(collection);\n    HOOKS_KEYS.forEach(key => {\n        HOOKS_WHEN.map(when => {\n            const fnName = when + ucfirst(key);\n            colProto[fnName] = function (fun: string, parallel: boolean) {\n                return this.addHook(when, key, fun, parallel);\n            };\n        });\n    });\n}\n\nfunction _incrementalUpsertUpdate<RxDocType>(\n    doc: RxDocumentBase<RxDocType>,\n    json: RxDocumentData<RxDocType>\n): Promise<RxDocumentBase<RxDocType>> {\n    return doc.incrementalModify((_innerDoc) => {\n        return json;\n    });\n}\n\n/**\n * ensures that the given document exists\n * @return promise that resolves with new doc and flag if inserted\n */\nfunction _incrementalUpsertEnsureRxDocumentExists<RxDocType>(\n    rxCollection: RxCollection<RxDocType>,\n    primary: string,\n    json: any\n): Promise<\n    {\n        doc: RxDocument<RxDocType>;\n        inserted: boolean;\n    }\n> {\n    /**\n     * Optimisation shortcut,\n     * first try to find the document in the doc-cache\n     */\n    const docDataFromCache = rxCollection._docCache.getLatestDocumentDataIfExists(primary);\n    if (docDataFromCache) {\n        return Promise.resolve({\n            doc: rxCollection._docCache.getCachedRxDocument(docDataFromCache),\n            inserted: false\n        });\n    }\n    return rxCollection.findOne(primary).exec()\n        .then(doc => {\n            if (!doc) {\n                return rxCollection.insert(json).then(newDoc => ({\n                    doc: newDoc,\n                    inserted: true\n                }));\n            } else {\n                return {\n                    doc,\n                    inserted: false\n                };\n            }\n        });\n}\n\n/**\n * creates and prepares a new collection\n */\nexport function createRxCollection(\n    {\n        database,\n        name,\n        schema,\n        instanceCreationOptions = {},\n        migrationStrategies = {},\n        autoMigrate = true,\n        statics = {},\n        methods = {},\n        attachments = {},\n        options = {},\n        localDocuments = false,\n        cacheReplacementPolicy = defaultCacheReplacementPolicy,\n        conflictHandler = defaultConflictHandler\n    }: any\n): Promise<RxCollection> {\n    const storageInstanceCreationParams: RxStorageInstanceCreationParams<any, any> = {\n        databaseInstanceToken: database.token,\n        databaseName: database.name,\n        collectionName: name,\n        schema: schema.jsonSchema,\n        options: instanceCreationOptions,\n        multiInstance: database.multiInstance,\n        password: database.password\n    };\n\n    runPluginHooks(\n        'preCreateRxStorageInstance',\n        storageInstanceCreationParams\n    );\n\n    return createRxCollectionStorageInstance(\n        database,\n        storageInstanceCreationParams\n    ).then(storageInstance => {\n        const collection = new RxCollectionBase(\n            database,\n            name,\n            schema,\n            storageInstance,\n            instanceCreationOptions,\n            migrationStrategies,\n            methods,\n            attachments,\n            options,\n            cacheReplacementPolicy,\n            statics,\n            conflictHandler\n        );\n\n        return collection\n            .prepare()\n            .then(() => {\n                // ORM add statics\n                Object\n                    .entries(statics)\n                    .forEach(([funName, fun]) => {\n                        Object.defineProperty(collection, funName, {\n                            get: () => (fun as any).bind(collection)\n                        });\n                    });\n\n                let ret = PROMISE_RESOLVE_VOID;\n                if (autoMigrate && collection.schema.version !== 0) {\n                    ret = collection.migratePromise();\n                }\n                return ret;\n            })\n            .then(() => {\n                runPluginHooks('createRxCollection', {\n                    collection,\n                    creator: {\n                        name,\n                        schema,\n                        storageInstance,\n                        instanceCreationOptions,\n                        migrationStrategies,\n                        methods,\n                        attachments,\n                        options,\n                        cacheReplacementPolicy,\n                        localDocuments,\n                        statics\n                    }\n                });\n                return collection as any;\n            })\n            /**\n             * If the collection creation fails,\n             * we yet have to close the storage instances.\n             */\n            .catch(err => {\n                return storageInstance.close()\n                    .then(() => Promise.reject(err));\n            });\n    });\n}\n\nexport function isRxCollection(obj: any): boolean {\n    return obj instanceof RxCollectionBase;\n}\n"],"mappings":";;;;;;;;;;;;AAAA;AAKA;AAYA;AAKA;AAIA;AAOA;AAGA;AAKA;AAIA;AA8DA;AAGA;AAMA;AACA;AACA;AAEA,IAAMA,UAAU,GAAG,CAAC,KAAK,EAAE,MAAM,CAAU;AAE3C,IAAMC,UAAU,GAAG,CAAC,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,QAAQ,CAAU;AAElE,IAAIC,YAAY,GAAG,KAAK;AAAC,IAEZC,gBAAgB;EAQzB;AACJ;AACA;;EAKI,0BACWC,QAAyE,EACzEC,IAAY,EACZC,MAAgC,EAChCC,uBAAwF,EASjG;IAAA,IARSC,uBAAgD,uEAAG,CAAC,CAAC;IAAA,IACrDC,mBAAmC,uEAAG,CAAC,CAAC;IAAA,IACxCC,OAAuB,uEAAG,CAAC,CAAC;IAAA,IAC5BC,WAA2B,uEAAG,CAAC,CAAC;IAAA,IAChCC,OAAY,uEAAG,CAAC,CAAC;IAAA,IACjBC,sBAAgD,uEAAGC,yCAA6B;IAAA,IAChFC,OAAuB,0EAAG,CAAC,CAAC;IAAA,IAC5BC,eAAkD,0EAAGC,2CAAsB;IAAA,KAhB/EC,eAAe,GAA2E,CAAC,CAAC;IAAA,KACnFC,QAAQ,GAAuC,IAAIC,GAAG,EAAE;IAAA,KACjEC,qBAAqB,GAA0C,CAAC,CAAC;IAAA,KAmCjEC,wBAAwB,GAA8B,IAAIC,GAAG,EAAE;IAAA,KAE/DC,MAAM,GAAY,KAAK;IAAA,KACvBC,KAAK,GAOR,CAAC,CAAC;IAAA,KACCC,KAAK,GAAmB,EAAE;IAAA,KAE1BC,SAAS,GAA8C,CAAC,CAAC;IAAA,KAEzDC,WAAW,GAAe,IAAAC,4BAAgB,GAAE;IAAA,KAC5CC,CAAC,GAA8C,CAAC,CAAC;IAAA,KACjDC,kBAAkB,GAAsB,CAAC,CAAC;IAAA,KAU1CC,SAAS,GAAgC,EAAE;IAAA,KAC3CC,SAAS,GAAG,KAAK;IAAA,KA5Db7B,QAAyE,GAAzEA,QAAyE;IAAA,KACzEC,IAAY,GAAZA,IAAY;IAAA,KACZC,MAAgC,GAAhCA,MAAgC;IAAA,KAChCC,uBAAwF,GAAxFA,uBAAwF;IAAA,KACxFC,uBAAgD,GAAhDA,uBAAgD;IAAA,KAChDC,mBAAmC,GAAnCA,mBAAmC;IAAA,KACnCC,OAAuB,GAAvBA,OAAuB;IAAA,KACvBC,WAA2B,GAA3BA,WAA2B;IAAA,KAC3BC,OAAY,GAAZA,OAAY;IAAA,KACZC,sBAAgD,GAAhDA,sBAAgD;IAAA,KAChDE,OAAuB,GAAvBA,OAAuB;IAAA,KACvBC,eAAkD,GAAlDA,eAAkD;IAEzDkB,mBAAmB,CAAC,IAAI,CAACC,cAAc,CAAC;EAC5C;EAAC;EAAA,OAgDYC,OAAO;IAAA,6FAApB;MAAA;MAAA;MAAA;QAAA;UAAA;YACI,IAAI,CAAClB,eAAe,GAAG,IAAAmB,0CAAyB,EAC5C,IAAI,CAACjC,QAAQ,EACb,IAAI,CAACG,uBAAuB,EAC5B,IAAI,CAACD,MAAM,CAACgC,UAAU,CACzB;YACD,IAAI,CAACjB,qBAAqB,GAAG,IAAIkB,uCAAqB,CAClD,IAAI,CAACrB,eAAe,EACpB,IAAI,CAACZ,MAAM,CAACkC,WAAW,EACvB,UAACC,OAAO,EAAEC,OAAO;cAAA,OAAK,IAAAC,qCAAyB,EAAC,KAAI,EAASF,OAAO,EAAEC,OAAO,CAAC;YAAA,GAC9E,UAAAE,MAAM;cAAA,OAAI,KAAI,CAACC,SAAS,CAAC,MAAM,EAAE,MAAM,EAAED,MAAM,CAAC;YAAA,EACnD;YAED,IAAI,CAACd,CAAC,GAAG,IAAI,CAAC1B,QAAQ,CAAC0C,WAAW,CAACC,IAAI,CACnC,IAAAC,iBAAM,EAAC,UAAAC,eAAe;cAAA,OAAIA,eAAe,CAACC,cAAc,KAAK,KAAI,CAAC7C,IAAI;YAAA,EAAC,EACvE,IAAA8C,mBAAQ,EAAC,UAAAF,eAAe;cAAA,OAAIA,eAAe,CAACG,MAAM;YAAA,EAAC,CACtD;YACD,IAAI,CAACrB,kBAAkB,GAAG,IAAAsB,0CAAuB,EAAC,IAAI,CAAClB,cAAc,CAAC;YACtE,IAAI,CAACR,SAAS,GAAG,IAAI2B,uBAAa,CAC9B,IAAI,CAAChD,MAAM,CAACkC,WAAW,EACvB,IAAI,CAACV,CAAC,CAACiB,IAAI,CAAC,IAAAC,iBAAM,EAAC,UAAAO,EAAE;cAAA,OAAI,CAACA,EAAE,CAACC,OAAO;YAAA,EAAC,CAAC,EACtC,UAAAC,OAAO;cAAA,OAAI,IAAAC,6CAAmB,EAAC,KAAI,CAACvB,cAAc,EAAEsB,OAAO,CAAC;YAAA,EAC/D;;YAED;AACR;AACA;AACA;AACA;YAJQ;YAAA,OAKmC,IAAI,CAACrD,QAAQ,CAACuD,YAAY;UAAA;YAAvDC,oBAAoB;YACpBC,OAAO,GAAG,IAAI,CAAC3C,eAAe,CAAC4C,YAAY,EAAE,CAACC,SAAS,CAAC,UAAAC,SAAS,EAAI;cACvE,IAAMf,eAAwE,GAAG;gBAC7EgB,EAAE,EAAED,SAAS,CAACC,EAAE;gBAChBC,QAAQ,EAAE,KAAK;gBACfhB,cAAc,EAAE,KAAI,CAAC7C,IAAI;gBACzBsD,YAAY,EAAEC,oBAAoB;gBAClCR,MAAM,EAAEY,SAAS,CAACZ,MAAM,CAACe,GAAG,CAAC,UAAAC,EAAE;kBAAA,OAAI,IAAAC,kDAAiC,EAChE,KAAK,EACLD,EAAE,EACF,KAAI,CACP;gBAAA,EAAC;gBACFE,aAAa,EAAE,KAAI,CAAClE,QAAQ,CAACmE,KAAK;gBAClCC,UAAU,EAAER,SAAS,CAACQ,UAAU;gBAChCC,OAAO,EAAET,SAAS,CAACS;cACvB,CAAC;cACD,KAAI,CAACrE,QAAQ,CAACsE,KAAK,CAACzB,eAAe,CAAC;YACxC,CAAC,CAAC;YACF,IAAI,CAACvB,KAAK,CAACiD,IAAI,CAACd,OAAO,CAAC;;YAExB;AACR;AACA;AACA;YACQ,IAAI,CAACnC,KAAK,CAACiD,IAAI,CACX,IAAI,CAACzD,eAAe,CACf0D,sBAAsB,EAAE,CACxBb,SAAS,CAAC,UAAAc,IAAI,EAAI;cACf,KAAI,CACC7D,eAAe,CAAC6D,IAAI,CAACC,KAAK,EAAED,IAAI,CAACJ,OAAO,CAAC,CACzCM,IAAI,CAAC,UAAAC,MAAM,EAAI;gBACZ,KAAI,CAAC9D,eAAe,CAAC+D,4BAA4B,CAAC;kBAC9ChB,EAAE,EAAEY,IAAI,CAACZ,EAAE;kBACXe,MAAM,EAANA;gBACJ,CAAC,CAAC;cACN,CAAC,CAAC;YACV,CAAC,CAAC,CACT;YAAC,iCAEKE,2BAAoB;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CAC9B;IAAA;MAAA;IAAA;IAAA;EAAA,IAGD;EAAA;EAAA,OACAC,eAAe,GAAf,2BAAoC;IAChC,MAAM,IAAAC,oBAAa,EAAC,WAAW,CAAC;EACpC,CAAC;EAAA,OACDC,eAAe,GAAf,2BAAgC;IAC5B,MAAM,IAAAD,oBAAa,EAAC,WAAW,CAAC;EACpC,CAAC;EAAA,OACDE,OAAO,GAAP,mBAA4D;IAAA,IAApDC,SAAiB,uEAAG,EAAE;IAC1B,OAAO,IAAI,CAACF,eAAe,EAAE,CAACC,OAAO,CAACC,SAAS,CAAC;EACpD,CAAC;EAAA,OACDC,cAAc,GAAd,0BAAqD;IAAA,IAAtCD,SAAiB,uEAAG,EAAE;IACjC,OAAO,IAAI,CAACF,eAAe,EAAE,CAACG,cAAc,CAACD,SAAS,CAAC;EAC3D,CAAC;EAAA,OAEKE,MAAM;IAAA,4FAAZ,kBACIC,IAAiC;MAAA;MAAA;QAAA;UAAA;YAGjC;YACMC,OAA4C,GAAG,IAAAC,8CAA0B,EAAC,IAAI,CAACtF,MAAM,EAAEoF,IAAI,CAAC;YAAA;YAAA,OAExE,IAAI,CAACG,UAAU,CAAC,CAACF,OAAO,CAAC,CAAC;UAAA;YAA9CG,WAAW;YAEXC,OAAO,GAAGD,WAAW,CAACE,KAAK,CAAC,CAAC,CAAC;YACpC,IAAAC,2CAA0B,EAAC,IAAI,EAASN,OAAO,CAAC,IAAI,CAACrF,MAAM,CAACkC,WAAW,CAAC,EAASkD,IAAI,EAAEK,OAAO,CAAC;YACzFG,YAAY,GAAG,IAAAC,qBAAc,EAACL,WAAW,CAACM,OAAO,CAAC,CAAC,CAAC,CAAC;YAAA,kCACpDF,YAAY;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CACtB;IAAA;MAAA;IAAA;IAAA;EAAA;EAAA,OAEKL,UAAU;IAAA,gGAAhB,kBACIQ,QAA0B;MAAA;MAAA;MAAA;QAAA;UAAA;YAAA,MAStBA,QAAQ,CAACC,MAAM,KAAK,CAAC;cAAA;cAAA;YAAA;YAAA,kCACd;cACHF,OAAO,EAAE,EAAE;cACXJ,KAAK,EAAE;YACX,CAAC;UAAA;YAGCO,OAAO,GAAGF,QAAQ,CAAClC,GAAG,CAAC,UAAAV,OAAO,EAAI;cACpC,IAAM+C,UAAU,GAAG,IAAAZ,8CAA0B,EAAC,MAAI,CAACtF,MAAM,EAAEmD,OAAO,CAAC;cACnE,OAAO+C,UAAU;YACrB,CAAC,CAAC;YAAA,KACW,IAAI,CAACC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC;cAAA;cAAA;YAAA;YAAA;YAAA,OACjCC,OAAO,CAACC,GAAG,CACbJ,OAAO,CAACpC,GAAG,CAAC,UAAAyC,GAAG,EAAI;cACf,OAAO,MAAI,CAAC/D,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE+D,GAAG,CAAC,CACtC7B,IAAI,CAAC,YAAM;gBACR,OAAO6B,GAAG;cACd,CAAC,CAAC;YACV,CAAC,CAAC,CACL;UAAA;YAAA;YAAA;YAAA;UAAA;YAAA,eAAGL,OAAO;UAAA;YARTM,IAAI;YASJC,OAAoC,GAAG,IAAIvF,GAAG,EAAE;YAChDwF,UAA0C,GAAGF,IAAI,CAAC1C,GAAG,CAAC,UAAAyC,GAAG,EAAI;cAC/DE,OAAO,CAACE,GAAG,CAAEJ,GAAG,CAAS,MAAI,CAACtG,MAAM,CAACkC,WAAW,CAAC,EAASoE,GAAG,CAAC;cAC9D,IAAMnD,OAAO,GAAGwD,MAAM,CAACC,MAAM,CAACN,GAAG,EAAE;gBAC/BO,YAAY,EAAE,CAAC,CAAC;gBAChBC,KAAK,EAAE,IAAAC,+BAAwB,GAAE;gBACjCC,IAAI,EAAE,IAAAC,yBAAkB,GAAE;gBAC1BC,QAAQ,EAAE;cACd,CAAC,CAAC;cACF,IAAMC,GAAiC,GAAG;gBAAEC,QAAQ,EAAEjE;cAAQ,CAAC;cAC/D,OAAOgE,GAAG;YACd,CAAC,CAAC;YAAA;YAAA,OACoB,IAAI,CAACvG,eAAe,CAACyG,SAAS,CAChDZ,UAAU,EACV,2BAA2B,CAC9B;UAAA;YAHKa,OAAO;YAKb;YACMC,cAAgD,GAAGZ,MAAM,CAACa,MAAM,CAACF,OAAO,CAACxB,OAAO,CAAC;YACjF2B,WAAkB,GAAGF,cAAc,CACpC1D,GAAG,CAAC,UAAC6D,cAAc;cAAA,OAAK,MAAI,CAACrG,SAAS,CAACsG,mBAAmB,CAACD,cAAc,CAAC;YAAA,EAAC;YAAA,KAE5E,IAAI,CAACvB,QAAQ,CAAC,MAAM,EAAE,QAAQ,CAAC;cAAA;cAAA;YAAA;YAAA;YAAA,OACzBC,OAAO,CAACC,GAAG,CACboB,WAAW,CAAC5D,GAAG,CAAC,UAAAyC,GAAG,EAAI;cACnB,OAAO,MAAI,CAAC/D,SAAS,CACjB,MAAM,EAAE,QAAQ,EAChBiE,OAAO,CAACoB,GAAG,CAACtB,GAAG,CAACuB,OAAO,CAAC,EACxBvB,GAAG,CACN;YACL,CAAC,CAAC,CACL;UAAA;YAAA,kCAGE;cACHR,OAAO,EAAE2B,WAAW;cACpB/B,KAAK,EAAEiB,MAAM,CAACa,MAAM,CAACF,OAAO,CAAC5B,KAAK;YACtC,CAAC;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CACJ;IAAA;MAAA;IAAA;IAAA;EAAA;EAAA,OAEKoC,UAAU;IAAA,gGAAhB,kBACIC,GAAa;MAAA;MAAA;MAAA;QAAA;UAAA;YAAA,MASTA,GAAG,CAAC/B,MAAM,KAAK,CAAC;cAAA;cAAA;YAAA;YAAA,kCACT;cACHF,OAAO,EAAE,EAAE;cACXJ,KAAK,EAAE;YACX,CAAC;UAAA;YAAA;YAAA,OAGuB,IAAI,CAACsC,SAAS,CAACD,GAAG,CAAC,CAACE,IAAI,EAAE;UAAA;YAAhDC,aAAa;YACbnC,QAA0C,GAAG,EAAE;YAC/CS,OAAoD,GAAG,IAAIvF,GAAG,EAAE;YACtEkH,KAAK,CAACC,IAAI,CAACF,aAAa,CAACV,MAAM,EAAE,CAAC,CAACa,OAAO,CAAC,UAAAC,UAAU,EAAI;cACrD,IAAMC,IAAoC,GAAGD,UAAU,CAACE,aAAa,CAAC,IAAI,CAAQ;cAClFzC,QAAQ,CAAC1B,IAAI,CAACkE,IAAI,CAAC;cACnB/B,OAAO,CAACE,GAAG,CAAC4B,UAAU,CAACT,OAAO,EAAEU,IAAI,CAAC;YACzC,CAAC,CAAC;YAAC;YAAA,OAEGnC,OAAO,CAACC,GAAG,CACbN,QAAQ,CAAClC,GAAG,CAAC,UAAAyC,GAAG,EAAI;cAChB,IAAMuB,OAAO,GAAIvB,GAAG,CAAS,MAAI,CAACtG,MAAM,CAACkC,WAAW,CAAC;cACrD,OAAO,MAAI,CAACK,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE+D,GAAG,EAAE4B,aAAa,CAACN,GAAG,CAACC,OAAO,CAAC,CAAC;YAC3E,CAAC,CAAC,CACL;UAAA;YACKY,UAA0C,GAAG1C,QAAQ,CAAClC,GAAG,CAAC,UAAAyC,GAAG,EAAI;cACnE,IAAMoC,QAAQ,GAAG,IAAAC,gBAAS,EAACrC,GAAG,CAAC;cAC/BoC,QAAQ,CAACxB,QAAQ,GAAG,IAAI;cACxB,OAAO;gBACH0B,QAAQ,EAAEtC,GAAG;gBACbc,QAAQ,EAAEsB;cACd,CAAC;YACL,CAAC,CAAC;YAAA;YAAA,OACoB,IAAI,CAAC9H,eAAe,CAACyG,SAAS,CAChDoB,UAAU,EACV,2BAA2B,CAC9B;UAAA;YAHKnB,OAAO;YAKPuB,UAAoB,GAAGlC,MAAM,CAACmC,IAAI,CAACxB,OAAO,CAACxB,OAAO,CAAC,EAEzD;YAAA;YAAA,OACMM,OAAO,CAACC,GAAG,CACbwC,UAAU,CAAChF,GAAG,CAAC,UAAAF,EAAE,EAAI;cACjB,OAAO,MAAI,CAACpB,SAAS,CACjB,MAAM,EACN,QAAQ,EACRiE,OAAO,CAACoB,GAAG,CAACjE,EAAE,CAAC,EACfuE,aAAa,CAACN,GAAG,CAACjE,EAAE,CAAC,CACxB;YACL,CAAC,CAAC,CACL;UAAA;YAEK8D,WAAW,GAAGoB,UAAU,CAAChF,GAAG,CAAC,UAAAF,EAAE;cAAA,OAAI,IAAAoF,wBAAiB,EAACb,aAAa,EAAEvE,EAAE,CAAC;YAAA,EAAC;YAAA,kCAEvE;cACHmC,OAAO,EAAE2B,WAAW;cACpB/B,KAAK,EAAEiB,MAAM,CAACa,MAAM,CAACF,OAAO,CAAC5B,KAAK;YACtC,CAAC;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CACJ;IAAA;MAAA;IAAA;IAAA;EAAA;EAED;AACJ;AACA;EAFI;EAAA,OAGMsD,UAAU;EAAA;EAAA;IAAA,gGAAhB,kBAAiBjD,QAAmC;MAAA;MAAA;MAAA;QAAA;UAAA;YAC1CkD,UAA4B,GAAG,EAAE;YACjCC,cAA2C,GAAG,IAAIjI,GAAG,EAAE;YAC7D8E,QAAQ,CAACsC,OAAO,CAAC,UAAAlF,OAAO,EAAI;cACxB,IAAMkC,OAAO,GAAG,IAAAC,8CAA0B,EAAC,MAAI,CAACtF,MAAM,EAAEmD,OAAO,CAAC;cAChE,IAAM0E,OAAe,GAAGxC,OAAO,CAAC,MAAI,CAACrF,MAAM,CAACkC,WAAW,CAAQ;cAC/D,IAAI,CAAC2F,OAAO,EAAE;gBACV,MAAM,IAAAsB,mBAAU,EAAC,MAAM,EAAE;kBACrBjH,WAAW,EAAE,MAAI,CAAClC,MAAM,CAACkC,WAAqB;kBAC9CqG,IAAI,EAAElD,OAAO;kBACbrF,MAAM,EAAE,MAAI,CAACA,MAAM,CAACgC;gBACxB,CAAC,CAAC;cACN;cACAkH,cAAc,CAACxC,GAAG,CAACmB,OAAO,EAAExC,OAAO,CAAC;cACpC4D,UAAU,CAAC5E,IAAI,CAACgB,OAAO,CAAC;YAC5B,CAAC,CAAC;YAAC;YAAA,OAEwB,IAAI,CAACE,UAAU,CAAC0D,UAAU,CAAC;UAAA;YAAhDrD,YAAY;YACdwD,GAAG,GAAGxD,YAAY,CAACE,OAAO,CAACuD,KAAK,CAAC,CAAC,CAAC;YAAA;YAAA,OACbjD,OAAO,CAACC,GAAG,CACjCT,YAAY,CAACF,KAAK,CAAC7B,GAAG;cAAA,yFAAC,kBAAO6B,KAAK;gBAAA;gBAAA;kBAAA;oBAAA;sBAAA,MAC3BA,KAAK,CAAC4D,MAAM,KAAK,GAAG;wBAAA;wBAAA;sBAAA;sBAAA,MACd,IAAAH,mBAAU,EAAC,KAAK,EAAE;wBACpBI,UAAU,EAAE,MAAI,CAACxJ,IAAI;wBACrByJ,UAAU,EAAE9D;sBAChB,CAAC,CAAC;oBAAA;sBAEA/B,EAAE,GAAG+B,KAAK,CAAC+D,UAAU;sBACrBC,SAAS,GAAG,IAAAX,wBAAiB,EAACG,cAAc,EAAEvF,EAAE,CAAC;sBACjDgG,WAAW,GAAG,IAAA9D,qBAAc,EAACH,KAAK,CAACkE,YAAY,CAAC;sBAChDtD,GAAG,GAAG,MAAI,CAACjF,SAAS,CAACsG,mBAAmB,CAACgC,WAAW,CAAC;sBAAA;sBAAA,OACtCrD,GAAG,CAACuD,iBAAiB,CAAC;wBAAA,OAAMH,SAAS;sBAAA,EAAC;oBAAA;sBAArDI,MAAM;sBAAA,kCACLA,MAAM;oBAAA;oBAAA;sBAAA;kBAAA;gBAAA;cAAA,CAChB;cAAA;gBAAA;cAAA;YAAA,IAAC,CACL;UAAA;YAfKC,WAAW;YAgBjBX,GAAG,GAAGA,GAAG,CAACY,MAAM,CAACD,WAAW,CAAC;YAAC,kCACvBX,GAAG;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CACb;IAAA;MAAA;IAAA;IAAA;EAAA;EAED;AACJ;AACA;EAFI;EAAA,OAGAa,MAAM,GAAN,gBAAO7E,IAA6B,EAAmD;IACnF,OAAO,IAAI,CAAC4D,UAAU,CAAC,CAAC5D,IAAI,CAAC,CAAC,CAACX,IAAI,CAAC,UAAAnC,MAAM;MAAA,OAAIA,MAAM,CAAC,CAAC,CAAC;IAAA,EAAC;EAC5D;;EAEA;AACJ;AACA,KAFI;EAAA,OAGA4H,iBAAiB,GAAjB,2BAAkB9E,IAA6B,EAAmD;IAAA;IAC9F,IAAMC,OAAO,GAAG,IAAAC,8CAA0B,EAAC,IAAI,CAACtF,MAAM,EAAEoF,IAAI,CAAC;IAC7D,IAAMyC,OAAe,GAAGxC,OAAO,CAAC,IAAI,CAACrF,MAAM,CAACkC,WAAW,CAAQ;IAC/D,IAAI,CAAC2F,OAAO,EAAE;MACV,MAAM,IAAAsB,mBAAU,EAAC,MAAM,EAAE;QACrBZ,IAAI,EAAEnD;MACV,CAAC,CAAC;IACN;;IAEA;IACA,IAAI+E,KAAK,GAAG,IAAI,CAACnJ,wBAAwB,CAAC4G,GAAG,CAACC,OAAO,CAAC;IACtD,IAAI,CAACsC,KAAK,EAAE;MACRA,KAAK,GAAGvF,2BAAoB;IAChC;IACAuF,KAAK,GAAGA,KAAK,CACR1F,IAAI,CAAC;MAAA,OAAM2F,wCAAwC,CAAC,MAAI,EAASvC,OAAO,EAASxC,OAAO,CAAC;IAAA,EAAC,CAC1FZ,IAAI,CAAC,UAAC4F,WAAW,EAAK;MACnB,IAAI,CAACA,WAAW,CAACC,QAAQ,EAAE;QACvB,OAAOC,wBAAwB,CAACF,WAAW,CAAC/D,GAAG,EAAEjB,OAAO,CAAC;MAC7D,CAAC,MAAM;QACH,OAAOgF,WAAW,CAAC/D,GAAG;MAC1B;IACJ,CAAC,CAAC;IACN,IAAI,CAACtF,wBAAwB,CAAC0F,GAAG,CAACmB,OAAO,EAAEsC,KAAK,CAAC;IACjD,OAAOA,KAAK;EAChB,CAAC;EAAA,OAEDK,IAAI,GAAJ,cAAKC,QAAqC,EAGxC;IACE,IAAI,OAAOA,QAAQ,KAAK,QAAQ,EAAE;MAC9B,MAAM,IAAAtB,mBAAU,EAAC,MAAM,EAAE;QACrBsB,QAAQ,EAARA;MACJ,CAAC,CAAC;IACN;IAEA,IAAI,CAACA,QAAQ,EAAE;MACXA,QAAQ,GAAG,IAAAC,yBAAgB,GAAE;IACjC;IAEA,IAAMC,KAAK,GAAG,IAAAC,sBAAa,EAAC,MAAM,EAAEH,QAAQ,EAAE,IAAI,CAAQ;IAC1D,OAAOE,KAAK;EAChB,CAAC;EAAA,OAEDE,OAAO,GAAP,iBACIJ,QAAqD,EAIvD;IACE,IAAIE,KAAK;IAET,IAAI,OAAOF,QAAQ,KAAK,QAAQ,EAAE;MAAA;MAC9BE,KAAK,GAAG,IAAAC,sBAAa,EAAC,SAAS,EAAE;QAC7BE,QAAQ,6BACH,IAAI,CAAC9K,MAAM,CAACkC,WAAW,IAAGuI,QAAQ,YACtC;QACDM,KAAK,EAAE;MACX,CAAC,EAAE,IAAI,CAAQ;IACnB,CAAC,MAAM;MACH,IAAI,CAACN,QAAQ,EAAE;QACXA,QAAQ,GAAG,IAAAC,yBAAgB,GAAE;MACjC;;MAEA;MACA,IAAKD,QAAQ,CAAgBM,KAAK,EAAE;QAChC,MAAM,IAAA5B,mBAAU,EAAC,KAAK,CAAC;MAC3B;MAECsB,QAAQ,CAASM,KAAK,GAAG,CAAC;MAC3BJ,KAAK,GAAG,IAAAC,sBAAa,EAAiB,SAAS,EAAEH,QAAQ,EAAE,IAAI,CAAQ;IAC3E;IAEA,IACI,OAAOA,QAAQ,KAAK,QAAQ,IAC5BtC,KAAK,CAAC6C,OAAO,CAACP,QAAQ,CAAC,EACzB;MACE,MAAM,IAAAQ,uBAAc,EAAC,MAAM,EAAE;QACzBR,QAAQ,EAARA;MACJ,CAAC,CAAC;IACN;IAEA,OAAOE,KAAK;EAChB,CAAC;EAAA,OAEDO,KAAK,GAAL,eAAMT,QAAqD,EAGzD;IACE,IAAI,CAACA,QAAQ,EAAE;MACXA,QAAQ,GAAG,IAAAC,yBAAgB,GAAE;IACjC;IACA,IAAMC,KAAK,GAAG,IAAAC,sBAAa,EAAC,OAAO,EAAEH,QAAQ,EAAE,IAAI,CAAQ;IAC3D,OAAOE,KAAK;EAChB;;EAEA;AACJ;AACA;AACA,KAHI;EAAA,OAIA3C,SAAS,GAAT,mBACID,GAAa,EAC+D;IAAA;IAC5E,IAAMoD,UAAsC,GAAG;MAC3CL,QAAQ,+BACH,IAAI,CAAC9K,MAAM,CAACkC,WAAW,IAAG;QACvBkJ,GAAG,EAAErD,GAAG,CAACsB,KAAK,CAAC,CAAC;MACpB,CAAC;IAET,CAAC;IACD,IAAMsB,KAAK,GAAG,IAAAC,sBAAa,EAAC,WAAW,EAAEO,UAAU,EAAE,IAAI,CAAQ;IACjE,OAAOR,KAAK;EAChB;;EAEA;AACJ;AACA,KAFI;EAAA,OAKAU,UAAU,GAAV,sBAA2B;IACvB,MAAM,IAAAvG,oBAAa,EAAC,WAAW,CAAC;EACpC;;EAEA;AACJ;AACA;AACA,KAHI;EAAA,OAIAwG,UAAU,GAAV,oBAAWC,aAAkD,EAAiB;IAC1E,MAAM,IAAAzG,oBAAa,EAAC,WAAW,CAAC;EACpC,CAAC;EAAA,OAED0G,UAAU,GAAV,oBAAWC,UAA6C,EAA0C;IAC9F,MAAM,IAAA3G,oBAAa,EAAC,MAAM,CAAC;EAC/B;;EAEA;AACJ;AACA,KAFI;EAAA,OAGA4G,WAAW,GAAX,qBAAkCC,QAA4D,EAA6D;IACvJ,MAAM,IAAA7G,oBAAa,EAAC,qBAAqB,CAAC;EAC9C,CAAC;EAAA,OAED8G,WAAW,GAAX,qBAAYC,YAAgD,EAA6C;IACrG,MAAM,IAAA/G,oBAAa,EAAC,qBAAqB,CAAC;EAC9C,CAAC;EAAA,OAEDgH,OAAO,GAAP,iBAAQD,YAA4C,EAAwC;IACxF,MAAM,IAAA/G,oBAAa,EAAC,iBAAiB,CAAC;EAC1C,CAAC;EAAA,OACDiH,aAAa,GAAb,uBAAcF,YAAkD,EAA+C;IAC3G,MAAM,IAAA/G,oBAAa,EAAC,uBAAuB,CAAC;EAChD;;EAGA;AACJ;AACA,KAFI;EAAA,OAGAkH,OAAO,GAAP,iBAAQC,IAAkB,EAAEC,GAAgB,EAAEC,GAAQ,EAAoB;IAAA,IAAlBC,QAAQ,uEAAG,KAAK;IACpE,IAAI,OAAOD,GAAG,KAAK,UAAU,EAAE;MAC3B,MAAM,IAAAlB,uBAAc,EAAC,MAAM,EAAE;QACzBiB,GAAG,EAAHA,GAAG;QACHD,IAAI,EAAJA;MACJ,CAAC,CAAC;IACN;IAEA,IAAI,CAACvM,UAAU,CAAC2M,QAAQ,CAACJ,IAAI,CAAC,EAAE;MAC5B,MAAM,IAAAhB,uBAAc,EAAC,MAAM,EAAE;QACzBiB,GAAG,EAAHA,GAAG;QACHD,IAAI,EAAJA;MACJ,CAAC,CAAC;IACN;IAEA,IAAI,CAACtM,UAAU,CAAC0M,QAAQ,CAACH,GAAG,CAAC,EAAE;MAC3B,MAAM,IAAA/C,mBAAU,EAAC,MAAM,EAAE;QACrB+C,GAAG,EAAHA;MACJ,CAAC,CAAC;IACN;IAEA,IAAID,IAAI,KAAK,MAAM,IAAIC,GAAG,KAAK,QAAQ,IAAIE,QAAQ,KAAK,IAAI,EAAE;MAC1D,MAAM,IAAAjD,mBAAU,EAAC,OAAO,EAAE;QACtB8C,IAAI,EAAJA,IAAI;QACJC,GAAG,EAAHA,GAAG;QACHE,QAAQ,EAARA;MACJ,CAAC,CAAC;IACN;;IAEA;IACA,IAAME,QAAQ,GAAGH,GAAG,CAACI,IAAI,CAAC,IAAI,CAAC;IAE/B,IAAMC,OAAO,GAAGJ,QAAQ,GAAG,UAAU,GAAG,QAAQ;IAEhD,IAAI,CAACjL,KAAK,CAAC+K,GAAG,CAAC,GAAG,IAAI,CAAC/K,KAAK,CAAC+K,GAAG,CAAC,IAAI,CAAC,CAAC;IACvC,IAAI,CAAC/K,KAAK,CAAC+K,GAAG,CAAC,CAACD,IAAI,CAAC,GAAG,IAAI,CAAC9K,KAAK,CAAC+K,GAAG,CAAC,CAACD,IAAI,CAAC,IAAI;MAC7CQ,MAAM,EAAE,EAAE;MACVL,QAAQ,EAAE;IACd,CAAC;IACD,IAAI,CAACjL,KAAK,CAAC+K,GAAG,CAAC,CAACD,IAAI,CAAC,CAACO,OAAO,CAAC,CAACnI,IAAI,CAACiI,QAAQ,CAAC;EACjD,CAAC;EAAA,OAEDI,QAAQ,GAAR,kBAAST,IAAkB,EAAEC,GAAgB,EAAE;IAC3C,IACI,CAAC,IAAI,CAAC/K,KAAK,CAAC+K,GAAG,CAAC,IAChB,CAAC,IAAI,CAAC/K,KAAK,CAAC+K,GAAG,CAAC,CAACD,IAAI,CAAC,EACxB;MACE,OAAO;QACHQ,MAAM,EAAE,EAAE;QACVL,QAAQ,EAAE;MACd,CAAC;IACL;IACA,OAAO,IAAI,CAACjL,KAAK,CAAC+K,GAAG,CAAC,CAACD,IAAI,CAAC;EAChC,CAAC;EAAA,OAED9F,QAAQ,GAAR,kBAAS8F,IAAkB,EAAEC,GAAgB,EAAE;IAC3C,IAAM/K,KAAK,GAAG,IAAI,CAACuL,QAAQ,CAACT,IAAI,EAAEC,GAAG,CAAC;IACtC,IAAI,CAAC/K,KAAK,EAAE;MACR,OAAO,KAAK;IAChB;IACA,OAAOA,KAAK,CAACsL,MAAM,CAACzG,MAAM,GAAG,CAAC,IAAI7E,KAAK,CAACiL,QAAQ,CAACpG,MAAM,GAAG,CAAC;EAC/D,CAAC;EAAA,OAEDzD,SAAS,GAAT,mBAAU0J,IAAkB,EAAEC,GAAgB,EAAE3D,IAAS,EAAEoE,QAAc,EAAgB;IACrF,IAAMxL,KAAK,GAAG,IAAI,CAACuL,QAAQ,CAACT,IAAI,EAAEC,GAAG,CAAC;IAEtC,IAAI,CAAC/K,KAAK,EAAE;MACR,OAAOyD,2BAAoB;IAC/B;;IAEA;IACA,IAAMgI,KAAK,GAAGzL,KAAK,CAACsL,MAAM,CAAC5I,GAAG,CAAC,UAACgJ,IAAS;MAAA,OAAK;QAAA,OAAMA,IAAI,CAACtE,IAAI,EAAEoE,QAAQ,CAAC;MAAA;IAAA,EAAC;IACzE,OAAO,IAAAG,oBAAa,EAACF,KAAK;IACtB;IAAA,CACCnI,IAAI,CAAC;MAAA,OAAM2B,OAAO,CAACC,GAAG,CACnBlF,KAAK,CAACiL,QAAQ,CACTvI,GAAG,CAAC,UAACgJ,IAAS;QAAA,OAAKA,IAAI,CAACtE,IAAI,EAAEoE,QAAQ,CAAC;MAAA,EAAC,CAChD;IAAA,EAAC;EACV;;EAEA;AACJ;AACA,KAFI;EAAA,OAGAI,aAAa,GAAb,uBAAcd,IAAkB,EAAEC,GAAgB,EAAE3D,IAAS,EAAEoE,QAAa,EAAE;IAC1E,IAAMxL,KAAK,GAAG,IAAI,CAACuL,QAAQ,CAACT,IAAI,EAAEC,GAAG,CAAC;IACtC,IAAI,CAAC/K,KAAK,EAAE;IACZA,KAAK,CAACsL,MAAM,CAACpE,OAAO,CAAC,UAACwE,IAAS;MAAA,OAAKA,IAAI,CAACtE,IAAI,EAAEoE,QAAQ,CAAC;IAAA,EAAC;EAC7D;;EAEA;AACJ;AACA;AACA;AACA,KAJI;EAAA,OAKAK,WAAW,GAAX,qBAAYC,IAAY,EAAiB;IAAA;IACrC,IAAM7D,GAAG,GAAG,IAAIhD,OAAO,CAAO,UAAA8G,GAAG,EAAI;MACjC,IAAMC,OAAO,GAAGC,UAAU,CAAC,YAAM;QAC7B,MAAI,CAACvM,QAAQ,UAAO,CAACsM,OAAO,CAAC;QAC7BD,GAAG,EAAE;MACT,CAAC,EAAED,IAAI,CAAC;MACR,MAAI,CAACpM,QAAQ,CAACwM,GAAG,CAACF,OAAO,CAAC;IAC9B,CAAC,CAAC;IACF,OAAO/D,GAAG;EACd,CAAC;EAAA,OAEDkE,OAAO,GAAP,mBAA4B;IAAA;IACxB,IAAI,IAAI,CAAC3L,SAAS,EAAE;MAChB,OAAO4L,4BAAqB;IAChC;;IAEA;AACR;AACA;AACA;AACA;AACA;IACQ,IAAI,CAAC5L,SAAS,GAAG,IAAI;IAGrBwG,KAAK,CAACC,IAAI,CAAC,IAAI,CAACvH,QAAQ,CAAC,CAACwH,OAAO,CAAC,UAAA8E,OAAO;MAAA,OAAIK,YAAY,CAACL,OAAO,CAAC;IAAA,EAAC;IACnE,IAAI,IAAI,CAAC1L,kBAAkB,EAAE;MACzB,IAAI,CAACA,kBAAkB,CAAC6L,OAAO,EAAE;IACrC;IACA;AACR;AACA;AACA;AACA;AACA;AACA;AACA;IACQ,OAAO,IAAI,CAACxN,QAAQ,CAAC2N,kBAAkB,EAAE,CACpChJ,IAAI,CAAC;MAAA,OAAM2B,OAAO,CAACC,GAAG,CAAC,MAAI,CAAC3E,SAAS,CAACmC,GAAG,CAAC,UAAA6J,EAAE;QAAA,OAAIA,EAAE,EAAE;MAAA,EAAC,CAAC;IAAA,EAAC,CACvDjJ,IAAI,CAAC;MAAA,OAAM,MAAI,CAAC7D,eAAe,CAAC+M,KAAK,EAAE;IAAA,EAAC,CACxClJ,IAAI,CAAC,YAAM;MACR;AAChB;AACA;AACA;AACA;AACA;MACgB,MAAI,CAACrD,KAAK,CAACiH,OAAO,CAAC,UAAAuF,GAAG;QAAA,OAAIA,GAAG,CAACC,WAAW,EAAE;MAAA,EAAC;MAE5C,OAAO,MAAI,CAAC/N,QAAQ,CAACgO,WAAW,CAAC,MAAI,CAAC/N,IAAI,CAAC;MAC3C,OAAO,IAAAgO,0BAAmB,EAAC,yBAAyB,EAAE,MAAI,CAAC,CAACtJ,IAAI,CAAC;QAAA,OAAM,IAAI;MAAA,EAAC;IAChF,CAAC,CAAC;EACV;;EAEA;AACJ;AACA,KAFI;EAAA,OAGMuJ,MAAM;EAAA;EAAA;IAAA,4FAAZ;MAAA;QAAA;UAAA;YAAA;YAAA,OACU,IAAI,CAACV,OAAO,EAAE;UAAA;YAAA;YAAA,OACd,IAAAW,4CAAwB,EAC1B,IAAI,CAACnO,QAAQ,CAACoO,OAAO,EACrB,IAAI,CAACpO,QAAQ,CAACqO,aAAa,EAC3B,IAAI,CAACrO,QAAQ,CAACmE,KAAK,EACnB,IAAI,CAACnE,QAAQ,CAACC,IAAI,EAClB,IAAI,CAACA,IAAI,EACT,IAAI,CAACD,QAAQ,CAACsO,YAAY,CAC7B;UAAA;UAAA;YAAA;QAAA;MAAA;IAAA,CACJ;IAAA;MAAA;IAAA;IAAA;EAAA;EAAA;IAAA;IAAA,KA/oBD,eAA+D;MAC3D,OAAO,IAAI,CAAC5M,CAAC,CAACiB,IAAI,CACd,IAAAC,iBAAM,EAAC,UAAAO,EAAE;QAAA,OAAIA,EAAE,CAACoL,SAAS,KAAK,QAAQ;MAAA,EAAC,CAC1C;IACL;EAAC;IAAA;IAAA,KACD,eAA+D;MAC3D,OAAO,IAAI,CAAC7M,CAAC,CAACiB,IAAI,CACd,IAAAC,iBAAM,EAAC,UAAAO,EAAE;QAAA,OAAIA,EAAE,CAACoL,SAAS,KAAK,QAAQ;MAAA,EAAC,CAC1C;IACL;EAAC;IAAA;IAAA,KACD,eAA+D;MAC3D,OAAO,IAAI,CAAC7M,CAAC,CAACiB,IAAI,CACd,IAAAC,iBAAM,EAAC,UAAAO,EAAE;QAAA,OAAIA,EAAE,CAACoL,SAAS,KAAK,QAAQ;MAAA,EAAC,CAC1C;IACL;EAAC;IAAA;IAAA,KAmoBD,eAA8E;MAC1E,OAAO,IAAI;IACf;EAAC;EAAA;AAAA;AAGL;AACA;AACA;AACA;AAHA;AAIA,SAASzM,mBAAmB,CACxB2H,UAAkC,EACpC;EACE,IAAI3J,YAAY,EAAE,OAAO,CAAC;EAC1BA,YAAY,GAAG,IAAI;EACnB,IAAM0O,QAAQ,GAAG3H,MAAM,CAAC4H,cAAc,CAAChF,UAAU,CAAC;EAClD5J,UAAU,CAAC0I,OAAO,CAAC,UAAA6D,GAAG,EAAI;IACtBxM,UAAU,CAACmE,GAAG,CAAC,UAAAoI,IAAI,EAAI;MACnB,IAAMuC,MAAM,GAAGvC,IAAI,GAAG,IAAAwC,cAAO,EAACvC,GAAG,CAAC;MAClCoC,QAAQ,CAACE,MAAM,CAAC,GAAG,UAAUrC,GAAW,EAAEC,QAAiB,EAAE;QACzD,OAAO,IAAI,CAACJ,OAAO,CAACC,IAAI,EAAEC,GAAG,EAAEC,GAAG,EAAEC,QAAQ,CAAC;MACjD,CAAC;IACL,CAAC,CAAC;EACN,CAAC,CAAC;AACN;AAEA,SAAS7B,wBAAwB,CAC7BjE,GAA8B,EAC9BlB,IAA+B,EACG;EAClC,OAAOkB,GAAG,CAACuD,iBAAiB,CAAC,UAAC6E,SAAS,EAAK;IACxC,OAAOtJ,IAAI;EACf,CAAC,CAAC;AACN;;AAEA;AACA;AACA;AACA;AACA,SAASgF,wCAAwC,CAC7CuE,YAAqC,EACrC9G,OAAe,EACfzC,IAAS,EAMX;EACE;AACJ;AACA;AACA;EACI,IAAMwJ,gBAAgB,GAAGD,YAAY,CAACtN,SAAS,CAACwN,6BAA6B,CAAChH,OAAO,CAAC;EACtF,IAAI+G,gBAAgB,EAAE;IAClB,OAAOxI,OAAO,CAAC0I,OAAO,CAAC;MACnBxI,GAAG,EAAEqI,YAAY,CAACtN,SAAS,CAACsG,mBAAmB,CAACiH,gBAAgB,CAAC;MACjEtE,QAAQ,EAAE;IACd,CAAC,CAAC;EACN;EACA,OAAOqE,YAAY,CAAC9D,OAAO,CAAChD,OAAO,CAAC,CAACI,IAAI,EAAE,CACtCxD,IAAI,CAAC,UAAA6B,GAAG,EAAI;IACT,IAAI,CAACA,GAAG,EAAE;MACN,OAAOqI,YAAY,CAACxJ,MAAM,CAACC,IAAI,CAAC,CAACX,IAAI,CAAC,UAAAqF,MAAM;QAAA,OAAK;UAC7CxD,GAAG,EAAEwD,MAAM;UACXQ,QAAQ,EAAE;QACd,CAAC;MAAA,CAAC,CAAC;IACP,CAAC,MAAM;MACH,OAAO;QACHhE,GAAG,EAAHA,GAAG;QACHgE,QAAQ,EAAE;MACd,CAAC;IACL;EACJ,CAAC,CAAC;AACV;;AAEA;AACA;AACA;AACO,SAASyE,kBAAkB,QAgBT;EAAA,IAdjBjP,QAAQ,SAARA,QAAQ;IACRC,IAAI,SAAJA,IAAI;IACJC,MAAM,SAANA,MAAM;IAAA,8BACNE,uBAAuB;IAAvBA,uBAAuB,sCAAG,CAAC,CAAC;IAAA,8BAC5BC,mBAAmB;IAAnBA,mBAAmB,sCAAG,CAAC,CAAC;IAAA,0BACxB6O,WAAW;IAAXA,WAAW,kCAAG,IAAI;IAAA,sBAClBvO,OAAO;IAAPA,OAAO,8BAAG,CAAC,CAAC;IAAA,sBACZL,OAAO;IAAPA,OAAO,8BAAG,CAAC,CAAC;IAAA,0BACZC,WAAW;IAAXA,WAAW,kCAAG,CAAC,CAAC;IAAA,sBAChBC,OAAO;IAAPA,OAAO,8BAAG,CAAC,CAAC;IAAA,6BACZ2O,cAAc;IAAdA,cAAc,qCAAG,KAAK;IAAA,8BACtB1O,sBAAsB;IAAtBA,sBAAsB,sCAAGC,yCAA6B;IAAA,8BACtDE,eAAe;IAAfA,eAAe,sCAAGC,2CAAsB;EAG5C,IAAMuO,6BAAwE,GAAG;IAC7EC,qBAAqB,EAAErP,QAAQ,CAACmE,KAAK;IACrCmL,YAAY,EAAEtP,QAAQ,CAACC,IAAI;IAC3B6C,cAAc,EAAE7C,IAAI;IACpBC,MAAM,EAAEA,MAAM,CAACgC,UAAU;IACzB1B,OAAO,EAAEJ,uBAAuB;IAChCmP,aAAa,EAAEvP,QAAQ,CAACuP,aAAa;IACrCC,QAAQ,EAAExP,QAAQ,CAACwP;EACvB,CAAC;EAED,IAAAC,qBAAc,EACV,4BAA4B,EAC5BL,6BAA6B,CAChC;EAED,OAAO,IAAAM,qDAAiC,EACpC1P,QAAQ,EACRoP,6BAA6B,CAChC,CAACzK,IAAI,CAAC,UAAA7D,eAAe,EAAI;IACtB,IAAM2I,UAAU,GAAG,IAAI1J,gBAAgB,CACnCC,QAAQ,EACRC,IAAI,EACJC,MAAM,EACNY,eAAe,EACfV,uBAAuB,EACvBC,mBAAmB,EACnBC,OAAO,EACPC,WAAW,EACXC,OAAO,EACPC,sBAAsB,EACtBE,OAAO,EACPC,eAAe,CAClB;IAED,OAAO6I,UAAU,CACZzH,OAAO,EAAE,CACT2C,IAAI,CAAC,YAAM;MACR;MACAkC,MAAM,CACD8I,OAAO,CAAChP,OAAO,CAAC,CAChB4H,OAAO,CAAC,iBAAoB;QAAA,IAAlBqH,OAAO;UAAEvD,GAAG;QACnBxF,MAAM,CAACgJ,cAAc,CAACpG,UAAU,EAAEmG,OAAO,EAAE;UACvC9H,GAAG,EAAE;YAAA,OAAOuE,GAAG,CAASI,IAAI,CAAChD,UAAU,CAAC;UAAA;QAC5C,CAAC,CAAC;MACN,CAAC,CAAC;MAEN,IAAIH,GAAG,GAAGxE,2BAAoB;MAC9B,IAAIoK,WAAW,IAAIzF,UAAU,CAACvJ,MAAM,CAAC4P,OAAO,KAAK,CAAC,EAAE;QAChDxG,GAAG,GAAGG,UAAU,CAACrE,cAAc,EAAE;MACrC;MACA,OAAOkE,GAAG;IACd,CAAC,CAAC,CACD3E,IAAI,CAAC,YAAM;MACR,IAAA8K,qBAAc,EAAC,oBAAoB,EAAE;QACjChG,UAAU,EAAVA,UAAU;QACVsG,OAAO,EAAE;UACL9P,IAAI,EAAJA,IAAI;UACJC,MAAM,EAANA,MAAM;UACNY,eAAe,EAAfA,eAAe;UACfV,uBAAuB,EAAvBA,uBAAuB;UACvBC,mBAAmB,EAAnBA,mBAAmB;UACnBC,OAAO,EAAPA,OAAO;UACPC,WAAW,EAAXA,WAAW;UACXC,OAAO,EAAPA,OAAO;UACPC,sBAAsB,EAAtBA,sBAAsB;UACtB0O,cAAc,EAAdA,cAAc;UACdxO,OAAO,EAAPA;QACJ;MACJ,CAAC,CAAC;MACF,OAAO8I,UAAU;IACrB,CAAC;IACD;AACZ;AACA;AACA,OAHY,SAIM,CAAC,UAAAuG,GAAG,EAAI;MACV,OAAOlP,eAAe,CAAC+M,KAAK,EAAE,CACzBlJ,IAAI,CAAC;QAAA,OAAM2B,OAAO,CAAC2J,MAAM,CAACD,GAAG,CAAC;MAAA,EAAC;IACxC,CAAC,CAAC;EACV,CAAC,CAAC;AACN;AAEO,SAASE,cAAc,CAACC,GAAQ,EAAW;EAC9C,OAAOA,GAAG,YAAYpQ,gBAAgB;AAC1C"}