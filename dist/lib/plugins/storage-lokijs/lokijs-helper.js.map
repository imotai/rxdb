{"version":3,"file":"lokijs-helper.js","names":["CHANGES_COLLECTION_SUFFIX","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE","RX_STORAGE_NAME_LOKIJS","stripLokiKey","docData","$loki","cloned","flatClone","$lastWriteAt","_meta","lwt","OPEN_LOKIJS_STORAGE_INSTANCES","Set","LOKIJS_COLLECTION_DEFAULT_OPTIONS","disableChangesApi","disableMeta","disableDeltaChangesApi","disableFreeze","cloneMethod","clone","transactional","autoupdate","LOKI_DATABASE_STATE_BY_NAME","Map","getLokiDatabase","databaseName","databaseSettings","databaseState","get","hasPersistence","adapter","persistenceMethod","useSettings","Object","assign","autoload","verbose","autosave","throttledSaves","database","lokijs","lokiSaveQueue","LokiSaveQueue","loadDatabasePromise","Promise","res","rej","loadDatabase","recursiveWait","err","autoloadCallback","saveQueue","then","unloads","push","unloadAdd","run","state","collections","set","closeLokiCollections","forEach","collection","collectionName","name","keys","length","u","remove","close","getLokiSortComparator","_schema","query","sort","newRxError","sortOptions","fun","a","b","compareResult","find","sortPart","fieldName","direction","values","directionMultiplier","valueA","objectPath","valueB","args","getLokiLeaderElector","databaseInstanceToken","broadcastChannelRefObject","broadcastChannel","getBroadcastChannelReference","elector","getLeaderElectorByBroadcastChannel","requestRemoteInstance","instance","operation","params","isRxStorageInstanceLoki","messageType","leaderElector","ensureNotFalsy","internals","waitUntilHasLeader","leaderDeadPromise","whenDeathListener","msg","context","action","retry","addEventListener","requestId","randomCouchString","responsePromise","_rej","responseListener","type","response","isError","error","result","postMessage","race","firstResolved","removeEventListener","handleRemoteRequest","console","dir","hasLeader","applyOnce","promiseWait","mustUseLocalState","closed","instanceClosed","localState","isLeader","createLokiLocalState","options","schema","multiInstance"],"sources":["../../../../src/plugins/storage-lokijs/lokijs-helper.ts"],"sourcesContent":["import { createLokiLocalState, RxStorageInstanceLoki } from './rx-storage-instance-loki';\nimport lokijs, { Collection } from 'lokijs';\nimport type {\n    LokiDatabaseSettings,\n    LokiDatabaseState,\n    LokiLocalDatabaseState,\n    LokiRemoteResponseBroadcastMessage,\n    MangoQuery,\n    MangoQuerySortDirection,\n    MangoQuerySortPart,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport {\n    add as unloadAdd,\n    AddReturn\n} from 'unload';\nimport { ensureNotFalsy, flatClone, promiseWait, randomCouchString } from '../utils';\nimport { LokiSaveQueue } from './loki-save-queue';\nimport type { DeterministicSortComparator } from 'event-reduce-js';\nimport { newRxError } from '../../rx-error';\nimport objectPath from 'object-path';\nimport {\n    LeaderElector,\n    OnMessageHandler\n} from 'broadcast-channel';\nimport { getBroadcastChannelReference } from '../../rx-storage-multiinstance';\nimport { getLeaderElectorByBroadcastChannel } from '../leader-election';\n\nexport const CHANGES_COLLECTION_SUFFIX = '-rxdb-changes';\nexport const LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request';\nexport const LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request-key-object';\nexport const RX_STORAGE_NAME_LOKIJS = 'lokijs';\n\n/**\n * Loki attaches a $loki property to all data\n * which must be removed before returning the data back to RxDB.\n */\nexport function stripLokiKey<T>(docData: RxDocumentData<T> & { $loki?: number; }): T {\n    if (!docData.$loki) {\n        return docData;\n    }\n    const cloned = flatClone(docData);\n\n    /**\n     * In RxDB version 12.0.0,\n     * we introduced the _meta field that already contains the last write time.\n     * To be backwards compatible, we have to move the $lastWriteAt to the _meta field.\n     * TODO remove this in the next major version.\n     */\n    if ((cloned as any).$lastWriteAt) {\n        cloned._meta = {\n            lwt: (cloned as any).$lastWriteAt\n        };\n        delete (cloned as any).$lastWriteAt;\n    }\n\n    delete cloned.$loki;\n    return cloned;\n}\n\n/**\n * Used to check in tests if all instances have been cleaned up.\n */\nexport const OPEN_LOKIJS_STORAGE_INSTANCES: Set<RxStorageInstanceLoki<any>> = new Set();\n\n\nexport const LOKIJS_COLLECTION_DEFAULT_OPTIONS: Partial<CollectionOptions<any>> = {\n    disableChangesApi: true,\n    disableMeta: true,\n    disableDeltaChangesApi: true,\n    disableFreeze: true,\n    // TODO use 'immutable' like WatermelonDB does it\n    cloneMethod: 'shallow-assign',\n    clone: false,\n    transactional: false,\n    autoupdate: false\n};\n\nconst LOKI_DATABASE_STATE_BY_NAME: Map<string, Promise<LokiDatabaseState>> = new Map();\nexport function getLokiDatabase(\n    databaseName: string,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiDatabaseState> {\n    let databaseState: Promise<LokiDatabaseState> | undefined = LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        /**\n         * We assume that as soon as an adapter is passed,\n         * the database has to be persistend.\n         */\n        const hasPersistence: boolean = !!databaseSettings.adapter;\n        databaseState = (async () => {\n            let persistenceMethod = hasPersistence ? 'adapter' : 'memory';\n            if (databaseSettings.persistenceMethod) {\n                persistenceMethod = databaseSettings.persistenceMethod;\n            }\n            const useSettings = Object.assign(\n                // defaults\n                {\n                    autoload: hasPersistence,\n                    persistenceMethod,\n                    verbose: true\n                },\n                databaseSettings,\n                // overwrites\n                {\n                    /**\n                     * RxDB uses its custom load and save handling\n                     * so we disable the LokiJS save/load handlers.\n                     */\n                    autoload: false,\n                    autosave: false,\n                    throttledSaves: false\n                }\n            );\n            const database = new lokijs(\n                databaseName + '.db',\n                flatClone(useSettings)\n            );\n            const lokiSaveQueue = new LokiSaveQueue(\n                database,\n                useSettings\n            );\n\n            /**\n             * Wait until all data is loaded from persistence adapter.\n             * Wrap the loading into the saveQueue to ensure that when many\n             * collections are created at the same time, the load-calls do not interfere\n             * with each other and cause error logs.\n             */\n            if (hasPersistence) {\n                const loadDatabasePromise = new Promise<void>((res, rej) => {\n                    try {\n                        database.loadDatabase({\n                            recursiveWait: false\n                        }, (err) => {\n                            if (useSettings.autoloadCallback) {\n                                useSettings.autoloadCallback(err);\n                            }\n                            if (err) {\n                                rej(err);\n                            } else {\n                                res();\n                            }\n                        });\n                    } catch (err) {\n                        rej(err);\n                    }\n                });\n                lokiSaveQueue.saveQueue = lokiSaveQueue.saveQueue.then(() => loadDatabasePromise);\n                await loadDatabasePromise;\n            }\n\n            /**\n             * Autosave database on process end\n             */\n            const unloads: AddReturn[] = [];\n            if (hasPersistence) {\n                unloads.push(\n                    unloadAdd(() => lokiSaveQueue.run())\n                );\n            }\n\n            const state: LokiDatabaseState = {\n                database,\n                databaseSettings: useSettings,\n                saveQueue: lokiSaveQueue,\n                collections: {},\n                unloads\n            };\n\n            return state;\n        })();\n        LOKI_DATABASE_STATE_BY_NAME.set(databaseName, databaseState);\n    }\n    return databaseState;\n}\n\nexport async function closeLokiCollections(\n    databaseName: string,\n    collections: Collection[]\n) {\n    const databaseState = await LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        // already closed\n        return;\n    }\n    await databaseState.saveQueue.run();\n    collections.forEach(collection => {\n        const collectionName = collection.name;\n        delete databaseState.collections[collectionName];\n    });\n    if (Object.keys(databaseState.collections).length === 0) {\n        // all collections closed -> also close database\n        LOKI_DATABASE_STATE_BY_NAME.delete(databaseName);\n        databaseState.unloads.forEach(u => u.remove());\n        await new Promise<void>((res, rej) => {\n            databaseState.database.close(err => {\n                if (err) {\n                    rej(err);\n                } else {\n                    res();\n                }\n            });\n        });\n    }\n}\n\n/**\n * This function is at lokijs-helper\n * because we need it in multiple places.\n */\nexport function getLokiSortComparator<RxDocType>(\n    _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    if (!query.sort) {\n        throw newRxError('SNH', { query });\n    }\n    const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort;\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        let compareResult: number = 0; // 1 | -1\n        sortOptions.find(sortPart => {\n            const fieldName: string = Object.keys(sortPart)[0];\n            const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\n            const directionMultiplier = direction === 'asc' ? 1 : -1;\n            const valueA: any = objectPath.get(a as any, fieldName);\n            const valueB: any = objectPath.get(b as any, fieldName);\n            if (valueA === valueB) {\n                return false;\n            } else {\n                if (valueA > valueB) {\n                    compareResult = 1 * directionMultiplier;\n                    return true;\n                } else {\n                    compareResult = -1 * directionMultiplier;\n                    return true;\n                }\n            }\n        });\n\n        /**\n         * Two different objects should never have the same sort position.\n         * We ensure this by having the unique primaryKey in the sort params\n         * which is added by RxDB if not existing yet.\n         */\n        if (!compareResult) {\n            throw newRxError('SNH', { args: { query, a, b } });\n        }\n\n        return compareResult as any;\n    };\n    return fun;\n}\n\nexport function getLokiLeaderElector(\n    databaseInstanceToken: string,\n    broadcastChannelRefObject: any,\n    databaseName: string\n): LeaderElector {\n    const broadcastChannel = getBroadcastChannelReference(\n        databaseInstanceToken,\n        databaseName,\n        broadcastChannelRefObject\n    );\n    const elector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n    return elector;\n}\n\n/**\n * For multi-instance usage, we send requests to the RxStorage\n * to the current leading instance over the BroadcastChannel.\n */\nexport async function requestRemoteInstance(\n    instance: RxStorageInstanceLoki<any>,\n    operation: string,\n    params: any[]\n): Promise<any | any[]> {\n    const isRxStorageInstanceLoki = typeof (instance as any).query === 'function';\n    const messageType = isRxStorageInstanceLoki ? LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE : LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE;\n\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n    const broadcastChannel = leaderElector.broadcastChannel;\n\n    type WinningPromise = {\n        retry: boolean;\n        result?: any;\n        error?: any;\n    };\n\n    let whenDeathListener: OnMessageHandler<any>;\n    const leaderDeadPromise = new Promise<WinningPromise>(res => {\n        whenDeathListener = (msg: any) => {\n            if (msg.context === 'leader' && msg.action === 'death') {\n                res({\n                    retry: true\n                });\n            }\n        };\n        broadcastChannel.addEventListener('internal', whenDeathListener);\n    });\n    const requestId = randomCouchString(12);\n    let responseListener: OnMessageHandler<any>;\n    const responsePromise = new Promise<WinningPromise>((res, _rej) => {\n        responseListener = (msg: any) => {\n            if (\n                msg.type === messageType &&\n                msg.response === true &&\n                msg.requestId === requestId\n            ) {\n                if (msg.isError) {\n                    res({\n                        retry: false,\n                        error: msg.result\n                    });\n                } else {\n                    res({\n                        retry: false,\n                        result: msg.result\n                    });\n                }\n            }\n        };\n        broadcastChannel.addEventListener('message', responseListener);\n    });\n\n    // send out the request to the other instance\n    broadcastChannel.postMessage({\n        response: false,\n        type: messageType,\n        operation,\n        params,\n        requestId,\n        databaseName: instance.databaseName,\n        collectionName: instance.collectionName\n    });\n\n\n    return Promise.race([\n        leaderDeadPromise,\n        responsePromise\n    ]).then(firstResolved => {\n\n        // clean up listeners\n        broadcastChannel.removeEventListener('message', responseListener);\n        broadcastChannel.removeEventListener('internal', whenDeathListener);\n\n        if (firstResolved.retry) {\n            /**\n             * The leader died while a remote request was running\n             * we re-run the whole operation.\n             * We cannot just re-run requestRemoteInstance()\n             * because the current instance might be the new leader now\n             * and then we have to use the local state instead of requesting the remote.\n             */\n            return (instance as any)[operation](...params);\n        } else {\n            if (firstResolved.error) {\n                throw firstResolved.error;\n            } else {\n                return firstResolved.result;\n            }\n        }\n    });\n}\n\n/**\n * Handles a request that came from a remote instance via requestRemoteInstance()\n * Runs the requested operation over the local db instance and sends back the result.\n */\nexport async function handleRemoteRequest(\n    instance: RxStorageInstanceLoki<any>,\n    msg: any\n) {\n    if (\n        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n        msg.requestId &&\n        msg.databaseName === instance.databaseName &&\n        msg.collectionName === instance.collectionName &&\n        !msg.response\n    ) {\n        const operation = (msg as any).operation;\n        const params = (msg as any).params;\n        let result: any;\n        let isError = false;\n        try {\n            result = await (instance as any)[operation](...params);\n        } catch (err) {\n            console.dir(err);\n            isError = true;\n            result = err;\n        }\n        const response: LokiRemoteResponseBroadcastMessage = {\n            response: true,\n            requestId: msg.requestId,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            result,\n            isError,\n            type: msg.type\n        };\n        ensureNotFalsy(instance.internals.leaderElector).broadcastChannel.postMessage(response);\n    }\n}\n\n\nexport async function waitUntilHasLeader(leaderElector: LeaderElector) {\n    while (\n        !leaderElector.hasLeader\n    ) {\n        await leaderElector.applyOnce();\n        await promiseWait(0);\n    }\n}\n\n/**\n * If the local state must be used, that one is returned.\n * Returns false if a remote instance must be used.\n */\nexport async function mustUseLocalState(\n    instance: RxStorageInstanceLoki<any>\n): Promise<LokiLocalDatabaseState | false> {\n    if (instance.closed) {\n        /**\n         * If this happens, it means that RxDB made a call to an already closed storage instance.\n         * This must never happen because when RxDB closes a collection or database,\n         * all tasks must be cleared so that no more calls are made the the storage.\n         */\n        throw newRxError('SNH', {\n            args: {\n                instanceClosed: instance.closed,\n                databaseName: instance.databaseName,\n                collectionName: instance.collectionName\n            }\n        });\n    }\n\n\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n\n    /**\n     * It might already have a localState after the applying\n     * because another subtask also called mustUSeLocalState()\n     */\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n\n    if (\n        leaderElector.isLeader &&\n        !instance.internals.localState\n    ) {\n        // own is leader, use local instance\n        instance.internals.localState = createLokiLocalState<any>({\n            databaseInstanceToken: instance.databaseInstanceToken,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            options: instance.options,\n            schema: (instance as RxStorageInstanceLoki<any>).schema,\n            multiInstance: instance.internals.leaderElector ? true : false\n        }, instance.databaseSettings);\n        return ensureNotFalsy(instance.internals.localState);\n    } else {\n        // other is leader, send message to remote leading instance\n        return false;\n    }\n}\n"],"mappings":"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"}