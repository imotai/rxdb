{"version":3,"file":"index.js","names":["REPLICATION_STATE_BY_COLLECTION","WeakMap","RxReplicationState","replicationIdentifierHash","collection","deletedField","pull","push","live","retryTime","autoStart","subs","subjects","received","Subject","send","error","canceled","BehaviorSubject","active","initialReplicationComplete","received$","asObservable","send$","error$","canceled$","active$","callOnStart","undefined","remoteEvents$","replicationStates","get","set","onDestroy","cancel","Object","keys","forEach","key","defineProperty","startPromise","Promise","res","start","isStopped","pullModifier","modifier","DEFAULT_MODIFIER","pushModifier","database","metaInstanceCollectionName","name","all","storage","createStorageInstance","databaseName","collectionName","databaseInstanceToken","token","multiInstance","options","schema","RX_REPLICATION_META_INSTANCE_SCHEMA","addConnectedStorageToCollection","metaInstance","internalReplicationState","replicateRxStorageInstance","pushBatchSize","batchSize","pullBatchSize","forkInstance","storageInstance","hashFunction","identifier","conflictHandler","replicationHandler","masterChangeStream$","pipe","mergeMap","ev","useEv","flatClone","documents","map","doc","swapdeletedFieldToDefaultDeleted","d","masterChangesSince","checkpoint","done","result","handler","emitError","newRxError","errors","toArray","er","errorToPlainJson","direction","next","awaitRetry","ensureNotFalsy","useResult","masterWrite","rows","row","newDocumentState","assumedMasterState","swapDefaultDeletedTodeletedField","useRows","Array","isArray","pushRows","args","rxdb","conflicts","events","subscribe","err","processed","down","document","up","writeToMasterRow","combineLatest","isActive","stream$","awaitRxStorageReplicationFirstInSync","awaitRxStorageReplicationInSync","getValue","awaitInitialReplication","awaitInSync","requestIdlePromise","reSync","emitEvent","PROMISE_RESOLVE_FALSE","promises","cancelRxStorageReplication","checkpointQueue","then","close","sub","unsubscribe","complete","replicateRxCollection","replicationIdentifier","waitForLeadership","fastUnsecureHash","join","replicationState","startReplicationOnLeaderShip","mustWaitForLeadership","waitTillRun","PROMISE_RESOLVE_TRUE"],"sources":["../../../../src/plugins/replication/index.ts"],"sourcesContent":["/**\n * This plugin contains the primitives to create\n * a RxDB client-server replication.\n * It is used in the other replication plugins\n * but also can be used as standalone with a custom replication handler.\n */\n\nimport {\n    BehaviorSubject,\n    combineLatest,\n    mergeMap,\n    Observable,\n    Subject,\n    Subscription\n} from 'rxjs';\nimport type {\n    ReplicationOptions,\n    ReplicationPullHandlerResult,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxDocumentData,\n    RxError,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    RxStorageInstance,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationMeta,\n    RxTypeError,\n    WithDeleted\n} from '../../types';\nimport {\n    ensureNotFalsy,\n    errorToPlainJson,\n    fastUnsecureHash,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    toArray\n} from '../../plugins/utils';\nimport {\n    awaitRxStorageReplicationFirstInSync,\n    awaitRxStorageReplicationInSync,\n    cancelRxStorageReplication,\n    replicateRxStorageInstance,\n    RX_REPLICATION_META_INSTANCE_SCHEMA\n} from '../../replication-protocol';\nimport { newRxError } from '../../rx-error';\nimport {\n    awaitRetry,\n    DEFAULT_MODIFIER,\n    swapDefaultDeletedTodeletedField,\n    swapdeletedFieldToDefaultDeleted\n} from './replication-helper';\nimport {\n    addConnectedStorageToCollection\n} from '../../rx-database-internal-store';\n\n\nexport const REPLICATION_STATE_BY_COLLECTION: WeakMap<RxCollection, RxReplicationState<any, any>[]> = new WeakMap();\n\nexport class RxReplicationState<RxDocType, CheckpointType> {\n    public readonly subs: Subscription[] = [];\n    public readonly subjects = {\n        received: new Subject<RxDocumentData<RxDocType>>(), // all documents that are received from the endpoint\n        send: new Subject<WithDeleted<RxDocType>>(), // all documents that are send to the endpoint\n        error: new Subject<RxError | RxTypeError>(), // all errors that are received from the endpoint, emits new Error() objects\n        canceled: new BehaviorSubject<boolean>(false), // true when the replication was canceled\n        active: new BehaviorSubject<boolean>(false), // true when something is running, false when not\n        initialReplicationComplete: new BehaviorSubject<boolean>(false) // true the initial replication-cycle is over\n    };\n\n    readonly received$: Observable<RxDocumentData<RxDocType>> = this.subjects.received.asObservable();\n    readonly send$: Observable<WithDeleted<RxDocType>> = this.subjects.send.asObservable();\n    readonly error$: Observable<RxError | RxTypeError> = this.subjects.error.asObservable();\n    readonly canceled$: Observable<any> = this.subjects.canceled.asObservable();\n    readonly active$: Observable<boolean> = this.subjects.active.asObservable();\n\n    private startPromise: Promise<void>;\n    constructor(\n        /**\n         * hash of the identifier, used to flag revisions\n         * and to identify which documents state came from the remote.\n         */\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly deletedField: string,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live?: boolean,\n        public retryTime?: number,\n        public autoStart?: boolean,\n    ) {\n        let replicationStates = REPLICATION_STATE_BY_COLLECTION.get(collection);\n        if (!replicationStates) {\n            replicationStates = [];\n            REPLICATION_STATE_BY_COLLECTION.set(collection, replicationStates);\n        }\n        replicationStates.push(this);\n\n        // stop the replication when the collection gets destroyed\n        this.collection.onDestroy.push(() => this.cancel());\n\n        // create getters for the observables\n        Object.keys(this.subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this.subjects[key].asObservable();\n                }\n            });\n        });\n        const startPromise = new Promise<void>(res => {\n            this.callOnStart = res;\n        });\n        this.startPromise = startPromise;\n    }\n\n    private callOnStart: () => void = undefined as any;\n\n    public internalReplicationState?: RxStorageInstanceReplicationState<RxDocType>;\n    public metaInstance?: RxStorageInstance<RxStorageReplicationMeta, any, {}, any>;\n    public remoteEvents$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\n\n    public async start(): Promise<void> {\n        if (this.isStopped()) {\n            return;\n        }\n\n        // fill in defaults for pull & push\n        const pullModifier = this.pull && this.pull.modifier ? this.pull.modifier : DEFAULT_MODIFIER;\n        const pushModifier = this.push && this.push.modifier ? this.push.modifier : DEFAULT_MODIFIER;\n\n        const database = this.collection.database;\n        const metaInstanceCollectionName = this.collection.name + '-rx-replication-' + this.replicationIdentifierHash;\n        const [metaInstance] = await Promise.all([\n            this.collection.database.storage.createStorageInstance({\n                databaseName: database.name,\n                collectionName: metaInstanceCollectionName,\n                databaseInstanceToken: database.token,\n                multiInstance: database.multiInstance, // TODO is this always false?\n                options: {},\n                schema: RX_REPLICATION_META_INSTANCE_SCHEMA\n            }),\n            addConnectedStorageToCollection(\n                this.collection,\n                metaInstanceCollectionName,\n                RX_REPLICATION_META_INSTANCE_SCHEMA\n            )\n        ]);\n        this.metaInstance = metaInstance;\n\n        this.internalReplicationState = replicateRxStorageInstance({\n            pushBatchSize: this.push && this.push.batchSize ? this.push.batchSize : 100,\n            pullBatchSize: this.pull && this.pull.batchSize ? this.pull.batchSize : 100,\n            forkInstance: this.collection.storageInstance,\n            metaInstance: this.metaInstance,\n            hashFunction: database.hashFunction,\n            identifier: 'rx-replication-' + this.replicationIdentifierHash,\n            conflictHandler: this.collection.conflictHandler,\n            replicationHandler: {\n                masterChangeStream$: this.remoteEvents$.asObservable().pipe(\n                    mergeMap(async (ev) => {\n                        if (ev === 'RESYNC') {\n                            return ev;\n                        }\n                        const useEv = flatClone(ev);\n                        if (this.deletedField !== '_deleted') {\n                            useEv.documents = useEv.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc));\n                        }\n                        useEv.documents = await Promise.all(\n                            useEv.documents.map(d => pullModifier(d))\n                        );\n                        return useEv;\n                    })\n                ),\n                masterChangesSince: async (\n                    checkpoint: CheckpointType,\n                    batchSize: number\n                ) => {\n                    if (!this.pull) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n                    /**\n                     * Retries must be done here in the replication primitives plugin,\n                     * because the replication protocol itself has no\n                     * error handling.\n                     */\n                    let done = false;\n                    let result: ReplicationPullHandlerResult<RxDocType, CheckpointType> = {} as any;\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.pull.handler(\n                                checkpoint,\n                                batchSize\n                            );\n                            done = true;\n                        } catch (err: any | Error | Error[]) {\n                            const emitError = newRxError('RC_PULL', {\n                                checkpoint,\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\n                                direction: 'pull'\n                            });\n                            this.subjects.error.next(emitError);\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\n                        }\n                    }\n\n                    if (this.isStopped()) {\n                        return {\n                            checkpoint: null,\n                            documents: []\n                        };\n                    }\n\n                    const useResult = flatClone(result);\n                    if (this.deletedField !== '_deleted') {\n                        useResult.documents = useResult.documents.map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc));\n                    }\n                    useResult.documents = await Promise.all(\n                        useResult.documents.map(d => pullModifier(d))\n                    );\n                    return useResult;\n                },\n                masterWrite: async (\n                    rows: RxReplicationWriteToMasterRow<RxDocType>[]\n                ) => {\n                    if (!this.push) {\n                        return [];\n                    }\n                    let done = false;\n                    const useRows = await Promise.all(\n                        rows.map(async (row) => {\n                            row.newDocumentState = await pushModifier(row.newDocumentState);\n                            if (row.assumedMasterState) {\n                                row.assumedMasterState = await pushModifier(row.assumedMasterState);\n                            }\n                            if (this.deletedField !== '_deleted') {\n                                row.newDocumentState = swapDefaultDeletedTodeletedField(this.deletedField, row.newDocumentState) as any;\n                                if (row.assumedMasterState) {\n                                    row.assumedMasterState = swapDefaultDeletedTodeletedField(this.deletedField, row.assumedMasterState) as any;\n                                }\n                            }\n                            return row;\n                        })\n                    );\n\n                    let result: WithDeleted<RxDocType>[] = null as any;\n                    while (!done && !this.isStopped()) {\n                        try {\n                            result = await this.push.handler(useRows);\n                            /**\n                             * It is a common problem that people have wrongly behaving backend\n                             * that do not return an array with the conflicts on push requests.\n                             * So we run this check here to make it easier to debug.\n                             * @link https://github.com/pubkey/rxdb/issues/4103\n                             */\n                            if (!Array.isArray(result)) {\n                                throw newRxError(\n                                    'RC_PUSH_NO_AR',\n                                    {\n                                        pushRows: rows,\n                                        direction: 'push',\n                                        args: { result }\n                                    }\n                                );\n                            }\n                            done = true;\n                        } catch (err: any | Error | Error[] | RxError) {\n                            const emitError = (err as RxError).rxdb ? err : newRxError('RC_PUSH', {\n                                pushRows: rows,\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\n                                direction: 'push'\n                            });\n                            this.subjects.error.next(emitError);\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\n                        }\n                    }\n                    if (this.isStopped()) {\n                        return [];\n                    }\n                    const conflicts = ensureNotFalsy(result).map(doc => swapdeletedFieldToDefaultDeleted(this.deletedField, doc));\n                    return conflicts;\n                }\n            }\n        });\n        this.subs.push(\n            this.internalReplicationState.events.error.subscribe(err => {\n                this.subjects.error.next(err);\n            }),\n            this.internalReplicationState.events.processed.down\n                .subscribe(row => this.subjects.received.next(row.document as any)),\n            this.internalReplicationState.events.processed.up\n                .subscribe(writeToMasterRow => {\n                    this.subjects.send.next(writeToMasterRow.newDocumentState);\n                }),\n            combineLatest([\n                this.internalReplicationState.events.active.down,\n                this.internalReplicationState.events.active.up\n            ]).subscribe(([down, up]) => {\n                const isActive = down || up;\n                this.subjects.active.next(isActive);\n            })\n        );\n\n        if (\n            this.pull &&\n            this.pull.stream$ &&\n            this.live\n        ) {\n            this.subs.push(\n                this.pull.stream$.subscribe({\n                    next: ev => {\n                        this.remoteEvents$.next(ev);\n                    },\n                    error: err => {\n                        this.subjects.error.next(err);\n                    }\n                })\n            );\n        }\n\n        /**\n         * Non-live replications run once\n         * and then automatically get canceled.\n         */\n        if (!this.live) {\n            await awaitRxStorageReplicationFirstInSync(this.internalReplicationState);\n            await awaitRxStorageReplicationInSync(this.internalReplicationState);\n            await this.cancel();\n        }\n        this.callOnStart();\n    }\n\n    isStopped(): boolean {\n        if (this.subjects.canceled.getValue()) {\n            return true;\n        }\n        return false;\n    }\n\n    async awaitInitialReplication(): Promise<void> {\n        await this.startPromise;\n        return awaitRxStorageReplicationFirstInSync(\n            ensureNotFalsy(this.internalReplicationState)\n        );\n    }\n\n    /**\n     * Returns a promise that resolves when:\n     * - All local data is replicated with the remote\n     * - No replication cycle is running or in retry-state\n     *\n     * WARNING: USing this function directly in a multi-tab browser application\n     * is dangerous because only the leading instance will ever be replicated,\n     * so this promise will not resolve in the other tabs.\n     * For multi-tab support you should set and observe a flag in a local document.\n     */\n    async awaitInSync(): Promise<true> {\n        await this.startPromise;\n        await awaitRxStorageReplicationFirstInSync(ensureNotFalsy(this.internalReplicationState));\n\n        /**\n         * Often awaitInSync() is called directly after a document write,\n         * like in the unit tests.\n         * So we first have to await the idleness to ensure that all RxChangeEvents\n         * are processed already.\n         */\n        await this.collection.database.requestIdlePromise();\n\n        await awaitRxStorageReplicationInSync(ensureNotFalsy(this.internalReplicationState));\n\n        return true;\n    }\n\n    reSync() {\n        this.remoteEvents$.next('RESYNC');\n    }\n    emitEvent(ev: RxReplicationPullStreamItem<RxDocType, CheckpointType>) {\n        this.remoteEvents$.next(ev);\n    }\n\n    cancel(): Promise<any> {\n        if (this.isStopped()) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n\n        const promises: Promise<any>[] = [];\n\n        if (this.internalReplicationState) {\n            cancelRxStorageReplication(this.internalReplicationState);\n        }\n        if (this.metaInstance) {\n            promises.push(\n                ensureNotFalsy(this.internalReplicationState).checkpointQueue\n                    .then(() => ensureNotFalsy(this.metaInstance).close())\n            );\n        }\n\n        this.subs.forEach(sub => sub.unsubscribe());\n        this.subjects.canceled.next(true);\n\n        this.subjects.active.complete();\n        this.subjects.canceled.complete();\n        this.subjects.error.complete();\n        this.subjects.received.complete();\n        this.subjects.send.complete();\n\n        return Promise.all(promises);\n    }\n}\n\n\nexport function replicateRxCollection<RxDocType, CheckpointType>(\n    {\n        replicationIdentifier,\n        collection,\n        deletedField = '_deleted',\n        pull,\n        push,\n        live = true,\n        retryTime = 1000 * 5,\n        waitForLeadership = true,\n        autoStart = true,\n    }: ReplicationOptions<RxDocType, CheckpointType>\n): RxReplicationState<RxDocType, CheckpointType> {\n    const replicationIdentifierHash = fastUnsecureHash(\n        [\n            collection.database.name,\n            collection.name,\n            replicationIdentifier\n        ].join('|')\n    );\n    const replicationState = new RxReplicationState<RxDocType, CheckpointType>(\n        replicationIdentifierHash,\n        collection,\n        deletedField,\n        pull,\n        push,\n        live,\n        retryTime,\n        autoStart\n    );\n\n\n    startReplicationOnLeaderShip(waitForLeadership, replicationState);\n    return replicationState as any;\n}\n\n\nexport function startReplicationOnLeaderShip(\n    waitForLeadership: boolean,\n    replicationState: RxReplicationState<any, any>\n) {\n    /**\n     * Always await this Promise to ensure that the current instance\n     * is leader when waitForLeadership=true\n     */\n    const mustWaitForLeadership = waitForLeadership && replicationState.collection.database.multiInstance;\n    const waitTillRun: Promise<any> = mustWaitForLeadership ? replicationState.collection.database.waitForLeadership() : PROMISE_RESOLVE_TRUE;\n    return waitTillRun.then(() => {\n        if (replicationState.isStopped()) {\n            return;\n        }\n        if (replicationState.autoStart) {\n            replicationState.start();\n        }\n    });\n}\n"],"mappings":"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"}