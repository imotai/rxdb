{"version":3,"file":"local-documents-helper.js","names":["LOCAL_DOC_STATE_BY_PARENT","WeakMap","LOCAL_DOC_STATE_BY_PARENT_RESOLVED","createLocalDocStateByParent","parent","database","collectionName","name","statePromise","createLocalDocumentStorageInstance","token","storage","instanceCreationOptions","multiInstance","storageInstance","getWrappedStorageInstance","RX_LOCAL_DOCUMENT_SCHEMA","docCache","DocumentCache","$","pipe","filter","cE","isLocal","docData","createRxLocalDocument","incrementalWriteQueue","IncrementalWriteQueue","storageToken","databaseStorageToken","subLocalDocs","changeStream","subscribe","eventBulk","changeEventBulk","id","internal","undefined","events","map","ev","storageChangeEventToRxChangeEvent","databaseToken","checkpoint","context","$emit","_subs","push","state","set","getLocalDocStateByParent","get","newRxError","collection","databaseInstanceToken","databaseName","createStorageInstance","getCollectionLocalInstanceName","schema","options","closeStateByParent","then","close","removeLocalDocumentsStorageInstance","randomCouchString","remove","fillWithDefaultSettings","title","version","primaryKey","type","properties","maxLength","data","additionalProperties","required"],"sources":["../../../../src/plugins/local-documents/local-documents-helper.ts"],"sourcesContent":["import { filter } from 'rxjs/operators';\nimport { DocumentCache } from '../../doc-cache';\nimport { IncrementalWriteQueue } from '../../incremental-write';\nimport { newRxError } from '../../rx-error';\nimport { fillWithDefaultSettings } from '../../rx-schema-helper';\nimport {\n    getWrappedStorageInstance,\n    storageChangeEventToRxChangeEvent\n} from '../../rx-storage-helper';\nimport type {\n    LocalDocumentParent,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxChangeEventBulk,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxLocalDocumentData,\n    RxStorage\n} from '../../types';\nimport { randomCouchString } from '../../plugins/utils';\nimport { createRxLocalDocument } from './rx-local-document';\n\nexport const LOCAL_DOC_STATE_BY_PARENT: WeakMap<LocalDocumentParent, Promise<LocalDocumentState>> = new WeakMap();\nexport const LOCAL_DOC_STATE_BY_PARENT_RESOLVED: WeakMap<LocalDocumentParent, LocalDocumentState> = new WeakMap();\n\n\nexport function createLocalDocStateByParent(parent: LocalDocumentParent): void {\n    const database: RxDatabase = parent.database ? parent.database : parent as any;\n    const collectionName = parent.database ? parent.name : '';\n    const statePromise = (async () => {\n        let storageInstance = await createLocalDocumentStorageInstance(\n            database.token,\n            database.storage,\n            database.name,\n            collectionName,\n            database.instanceCreationOptions,\n            database.multiInstance\n        );\n        storageInstance = getWrappedStorageInstance(\n            database,\n            storageInstance,\n            RX_LOCAL_DOCUMENT_SCHEMA\n        );\n        const docCache = new DocumentCache<RxLocalDocumentData, {}>(\n            'id',\n            parent.$.pipe(\n                filter(cE => (cE as RxChangeEvent<any>).isLocal)\n            ),\n            docData => createRxLocalDocument(docData, parent) as any\n        );\n\n        const incrementalWriteQueue = new IncrementalWriteQueue(\n            storageInstance,\n            'id',\n            () => { },\n            () => { }\n        );\n\n        /**\n         * Emit the changestream into the collections change stream\n         */\n        const databaseStorageToken = await database.storageToken;\n        const subLocalDocs = storageInstance.changeStream().subscribe(eventBulk => {\n            const changeEventBulk: RxChangeEventBulk<RxLocalDocumentData> = {\n                id: eventBulk.id,\n                internal: false,\n                collectionName: parent.database ? parent.name : undefined,\n                storageToken: databaseStorageToken,\n                events: eventBulk.events.map(ev => storageChangeEventToRxChangeEvent(\n                    true,\n                    ev,\n                    parent.database ? parent as any : undefined\n                )),\n                databaseToken: database.token,\n                checkpoint: eventBulk.checkpoint,\n                context: eventBulk.context\n            };\n            database.$emit(changeEventBulk);\n        });\n        parent._subs.push(subLocalDocs);\n\n        const state = {\n            database,\n            parent,\n            storageInstance,\n            docCache,\n            incrementalWriteQueue\n        };\n        LOCAL_DOC_STATE_BY_PARENT_RESOLVED.set(parent, state);\n        return state;\n    })();\n    LOCAL_DOC_STATE_BY_PARENT.set(parent, statePromise);\n}\n\nexport function getLocalDocStateByParent(parent: LocalDocumentParent): Promise<LocalDocumentState> {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (!statePromise) {\n        const database: RxDatabase = parent.database ? parent.database : parent as any;\n        const collectionName = parent.database ? parent.name : '';\n        throw newRxError('LD8', {\n            database: database.name,\n            collection: collectionName\n        });\n    }\n    return statePromise;\n}\n\n\nexport function createLocalDocumentStorageInstance(\n    databaseInstanceToken: string,\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string,\n    instanceCreationOptions: any,\n    multiInstance: boolean\n) {\n    return storage.createStorageInstance<RxLocalDocumentData>({\n        databaseInstanceToken,\n        databaseName: databaseName,\n        /**\n         * Use a different collection name for the local documents instance\n         * so that the local docs can be kept while deleting the normal instance\n         * after migration.\n         */\n        collectionName: getCollectionLocalInstanceName(collectionName),\n        schema: RX_LOCAL_DOCUMENT_SCHEMA,\n        options: instanceCreationOptions,\n        multiInstance\n    });\n}\n\nexport function closeStateByParent(parent: LocalDocumentParent) {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (statePromise) {\n        LOCAL_DOC_STATE_BY_PARENT.delete(parent);\n        return statePromise.then(state => state.storageInstance.close());\n    }\n}\n\nexport async function removeLocalDocumentsStorageInstance(\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string\n) {\n    const databaseInstanceToken = randomCouchString(10);\n    const storageInstance = await createLocalDocumentStorageInstance(\n        databaseInstanceToken,\n        storage,\n        databaseName,\n        collectionName,\n        {},\n        false\n    );\n    await storageInstance.remove();\n}\n\n\nexport function getCollectionLocalInstanceName(collectionName: string): string {\n    return 'plugin-local-documents-' + collectionName;\n}\n\nexport const RX_LOCAL_DOCUMENT_SCHEMA: RxJsonSchema<RxDocumentData<RxLocalDocumentData>> = fillWithDefaultSettings({\n    title: 'RxLocalDocument',\n    version: 0,\n    primaryKey: 'id',\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 128\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    required: [\n        'id',\n        'data'\n    ]\n});\n"],"mappings":"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"}