{"version":3,"file":"index.js","names":["RxFirestoreReplicationState","firestore","replicationIdentifierHash","collection","pull","push","live","retryTime","autoStart","RxReplicationState","syncFirestore","options","pullStream$","Subject","replicationPrimitivesPull","waitForLeadership","serverTimestampField","primaryPath","schema","schemaPart","getSchemaByObjectPath","jsonSchema","includes","newRxError","field","handler","lastPulledCheckpoint","batchSize","lastServerTimestamp","isoStringToServerTimestamp","serverTimestamp","newerQuery","query","where","orderBy","limit","sameTimeQuery","id","mustsReRun","useDocs","waitForPendingWrites","database","runTransaction","_tx","Promise","all","getDocs","undefined","newerQueryResult","sameTimeQueryResult","metadata","hasPendingWrites","ensureNotFalsy","docs","missingAmount","length","additonalDocs","slice","filter","x","concat","checkpoint","documents","lastDoc","lastOfArray","map","row","firestoreRowToDocData","newCheckpoint","serverTimestampToIsoString","data","ret","modifier","stream$","asObservable","replicationPrimitivesPush","rows","writeRowsById","docIds","docId","newDocumentState","conflicts","documentId","docsInDbResult","docsInDbById","forEach","docDataInDb","stripServerTimestampField","batch","writeBatch","hasWrite","Object","entries","writeRow","docInDb","assumedMasterState","conflictHandler","realMasterState","isEqual","docRef","doc","writeDocData","flatClone","set","stripPrimaryKey","update","commit","replicationState","FIRESTORE_REPLICATION_PLUGIN_IDENTITY_PREFIX","fastUnsecureHash","projectId","startBefore","start","bind","cancelBefore","cancel","lastChangeQuery","unsubscribe","onSnapshot","_querySnapshot","reSync","error","subjects","next","errorToPlainJson","startReplicationOnLeaderShip","RxDBReplicationFirestorePlugin","name","init","addRxPlugin","RxDBLeaderElectionPlugin","rxdb","prototypes","RxCollection","proto"],"sources":["../../../../src/plugins/replication-firestore/index.ts"],"sourcesContent":["/**\n * this plugin adds the RxCollection.syncCouchDB()-function to rxdb\n * you can use it to sync collections with a remote CouchDB endpoint.\n */\nimport {\n    ensureNotFalsy,\n    errorToPlainJson,\n    fastUnsecureHash,\n    flatClone,\n    lastOfArray\n} from '../../plugins/utils';\n\nimport {\n    doc,\n    query,\n    where,\n    orderBy,\n    limit,\n    getDocs,\n    onSnapshot,\n    runTransaction,\n    writeBatch,\n    serverTimestamp,\n    QueryDocumentSnapshot,\n    waitForPendingWrites,\n    documentId\n} from 'firebase/firestore';\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport type {\n    RxCollection,\n    RxPlugin,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxReplicationWriteToMasterRow,\n    RxReplicationPullStreamItem\n} from '../../types';\nimport {\n    RxReplicationState,\n    startReplicationOnLeaderShip\n} from '../replication';\nimport {\n    addRxPlugin,\n    ById,\n    getSchemaByObjectPath,\n    newRxError,\n    WithDeleted\n} from '../../';\n\nimport type {\n    FirestoreCheckpointType,\n    FirestoreOptions,\n    SyncOptionsFirestore\n} from './firestore-types';\nimport { Subject } from 'rxjs';\nimport {\n    firestoreRowToDocData,\n    FIRESTORE_REPLICATION_PLUGIN_IDENTITY_PREFIX,\n    isoStringToServerTimestamp,\n    serverTimestampToIsoString,\n    stripPrimaryKey,\n    stripServerTimestampField\n} from './firestore-helper';\n\nexport * from './firestore-helper';\nexport * from './firestore-types';\n\nexport class RxFirestoreReplicationState<RxDocType> extends RxReplicationState<RxDocType, FirestoreCheckpointType> {\n    constructor(\n        public readonly firestore: FirestoreOptions<RxDocType>,\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, FirestoreCheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifierHash,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\nexport function syncFirestore<RxDocType>(\n    this: RxCollection<RxDocType>,\n    options: SyncOptionsFirestore<RxDocType>\n): RxFirestoreReplicationState<RxDocType> {\n    const collection = this;\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, FirestoreCheckpointType>> = new Subject();\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, FirestoreCheckpointType> | undefined;\n    options.live = typeof options.live === 'undefined' ? true : options.live;\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n    const serverTimestampField = typeof options.serverTimestampField === 'undefined' ? 'serverTimestamp' : options.serverTimestampField;\n    options.serverTimestampField = serverTimestampField;\n    const primaryPath = collection.schema.primaryPath;\n\n    /**\n     * The serverTimestampField MUST NOT be part of the collections RxJsonSchema.\n     */\n    const schemaPart = getSchemaByObjectPath(this.schema.jsonSchema, serverTimestampField);\n    if (\n        schemaPart ||\n        // also must not be nested.\n        serverTimestampField.includes('.')\n    ) {\n        throw newRxError('RC6', {\n            field: serverTimestampField,\n            schema: this.schema.jsonSchema\n        });\n    }\n\n    if (options.pull) {\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: FirestoreCheckpointType,\n                batchSize: number\n            ) {\n                let newerQuery: ReturnType<typeof query>;\n                let sameTimeQuery: ReturnType<typeof query> | undefined;\n\n                if (lastPulledCheckpoint) {\n                    const lastServerTimestamp = isoStringToServerTimestamp(lastPulledCheckpoint.serverTimestamp);\n                    newerQuery = query(options.firestore.collection,\n                        where(serverTimestampField, '>', lastServerTimestamp),\n                        orderBy(serverTimestampField, 'asc'),\n                        limit(batchSize)\n                    );\n                    sameTimeQuery = query(options.firestore.collection,\n                        where(serverTimestampField, '==', lastServerTimestamp),\n                        where(primaryPath, '>', lastPulledCheckpoint.id),\n                        orderBy(primaryPath, 'asc'),\n                        orderBy(serverTimestampField, 'asc'),\n                        limit(batchSize)\n                    );\n                } else {\n                    newerQuery = query(options.firestore.collection,\n                        orderBy(serverTimestampField, 'asc'),\n                        limit(batchSize)\n                    );\n                }\n\n                let mustsReRun = true;\n                let useDocs: QueryDocumentSnapshot<RxDocType>[] = [];\n                while (mustsReRun) {\n                    /**\n                     * Local writes that have not been persisted to the server\n                     * are in pending state and do not have a correct serverTimestamp set.\n                     * We have to ensure we only use document states that are in sync with the server.\n                     * @link https://medium.com/firebase-developers/the-secrets-of-firestore-fieldvalue-servertimestamp-revealed-29dd7a38a82b\n                     */\n                    await waitForPendingWrites(options.firestore.database);\n                    await runTransaction(options.firestore.database, async (_tx) => {\n                        useDocs = [];\n                        const [\n                            newerQueryResult,\n                            sameTimeQueryResult\n                        ] = await Promise.all([\n                            getDocs(newerQuery),\n                            sameTimeQuery ? getDocs(sameTimeQuery) : undefined\n                        ]);\n\n                        if (\n                            newerQueryResult.metadata.hasPendingWrites ||\n                            (sameTimeQuery && ensureNotFalsy(sameTimeQueryResult).metadata.hasPendingWrites)\n                        ) {\n                            return;\n                        } else {\n                            mustsReRun = false;\n\n                            if (sameTimeQuery) {\n                                useDocs = ensureNotFalsy(sameTimeQueryResult).docs as any;\n                            }\n                            const missingAmount = batchSize - useDocs.length;\n                            if (missingAmount > 0) {\n                                const additonalDocs = newerQueryResult.docs.slice(0, missingAmount).filter(x => !!x);\n                                useDocs = useDocs.concat(additonalDocs as any);\n                            }\n                        }\n                    });\n                }\n\n                if (useDocs.length === 0) {\n                    return {\n                        checkpoint: lastPulledCheckpoint,\n                        documents: []\n                    };\n                }\n                const lastDoc = ensureNotFalsy(lastOfArray(useDocs));\n                const documents: WithDeleted<RxDocType>[] = useDocs\n                    .map(row => firestoreRowToDocData(\n                        serverTimestampField,\n                        primaryPath,\n                        row\n                    ));\n                const newCheckpoint: FirestoreCheckpointType = {\n                    id: lastDoc.id,\n                    serverTimestamp: serverTimestampToIsoString(serverTimestampField, lastDoc.data())\n                };\n                const ret = {\n                    documents: documents,\n                    checkpoint: newCheckpoint\n                };\n                return ret;\n            },\n            batchSize: ensureNotFalsy(options.pull).batchSize,\n            modifier: ensureNotFalsy(options.pull).modifier,\n            stream$: pullStream$.asObservable()\n        };\n    }\n\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\n    if (options.push) {\n        replicationPrimitivesPush = {\n            async handler(\n                rows: RxReplicationWriteToMasterRow<RxDocType>[]\n            ) {\n                const writeRowsById: ById<RxReplicationWriteToMasterRow<RxDocType>> = {};\n                const docIds: string[] = rows.map(row => {\n                    const docId = (row.newDocumentState as any)[primaryPath];\n                    writeRowsById[docId] = row;\n                    return docId;\n                });\n                await waitForPendingWrites(options.firestore.database);\n                let conflicts: WithDeleted<RxDocType>[] = [];\n\n                /**\n                 * Everything must run INSIDE of the transaction\n                 * because on tx-errors, firebase will re-run the transaction on some cases.\n                 * @link https://firebase.google.com/docs/firestore/manage-data/transactions#transaction_failure\n                 * @link https://firebase.google.com/docs/firestore/manage-data/transactions\n                 */\n                await runTransaction(options.firestore.database, async (_tx) => {\n                    conflicts = []; // reset in case the tx has re-run.\n                    /**\n                     * @link https://stackoverflow.com/a/48423626/3443137\n                     */\n                    const docsInDbResult = await getDocs(\n                        query(\n                            options.firestore.collection,\n                            where(documentId(), 'in', docIds)\n                        )\n                    );\n                    const docsInDbById: ById<RxDocType> = {};\n                    docsInDbResult.docs.forEach(row => {\n                        const docDataInDb = stripServerTimestampField(serverTimestampField, row.data());\n                        const docId = row.id;\n                        (docDataInDb as any)[primaryPath] = docId;\n                        docsInDbById[docId] = docDataInDb;\n                    });\n\n                    /**\n                     * @link https://firebase.google.com/docs/firestore/manage-data/transactions#batched-writes\n                     */\n                    const batch = writeBatch(options.firestore.database);\n                    let hasWrite = false;\n                    await Promise.all(\n                        Object.entries(writeRowsById).map(async ([docId, writeRow]) => {\n                            const docInDb: RxDocType | undefined = docsInDbById[docId];\n\n                            if (\n                                docInDb &&\n                                (\n                                    !writeRow.assumedMasterState ||\n                                    (await collection.conflictHandler({\n                                        newDocumentState: docInDb as any,\n                                        realMasterState: writeRow.assumedMasterState\n                                    }, 'replication-firestore-push')).isEqual === false\n                                )\n                            ) {\n                                // conflict\n                                conflicts.push(docInDb as any);\n                            } else {\n                                // no conflict\n                                hasWrite = true;\n                                const docRef = doc(options.firestore.collection, docId);\n                                const writeDocData = flatClone(writeRow.newDocumentState);\n                                (writeDocData as any)[serverTimestampField] = serverTimestamp();\n                                if (!docInDb) {\n                                    // insert\n                                    batch.set(docRef, stripPrimaryKey(primaryPath, writeDocData));\n                                } else {\n                                    // update\n                                    batch.update(docRef, stripPrimaryKey(primaryPath, writeDocData));\n                                }\n                            }\n                        })\n                    );\n\n                    if (hasWrite) {\n                        await batch.commit();\n                    }\n                });\n                await waitForPendingWrites(options.firestore.database);\n                return conflicts;\n            },\n            batchSize: options.push.batchSize,\n            modifier: options.push.modifier\n        };\n    }\n\n\n    const replicationState = new RxFirestoreReplicationState<RxDocType>(\n        options.firestore,\n        FIRESTORE_REPLICATION_PLUGIN_IDENTITY_PREFIX + fastUnsecureHash(options.firestore.projectId),\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Use long polling to get live changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        const cancelBefore = replicationState.cancel.bind(replicationState);\n        replicationState.start = () => {\n            const lastChangeQuery = query(\n                options.firestore.collection,\n                orderBy(serverTimestampField, 'desc'),\n                limit(1)\n            );\n            const unsubscribe = onSnapshot(\n                lastChangeQuery,\n                (_querySnapshot) => {\n                    /**\n                     * There is no good way to observe the event stream in firestore.\n                     * So instead we listen to any write to the collection\n                     * and then emit a 'RESYNC' flag.\n                     */\n                    replicationState.reSync();\n                },\n                (error) => {\n                    replicationState.subjects.error.next(\n                        newRxError('RC_STREAM', { error: errorToPlainJson(error) })\n                    );\n                }\n            );\n            replicationState.cancel = () => {\n                unsubscribe();\n                return cancelBefore();\n            };\n            return startBefore();\n        };\n    }\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n\n    return replicationState;\n}\n\nexport const RxDBReplicationFirestorePlugin: RxPlugin = {\n    name: 'replication-firestore',\n    init() {\n        addRxPlugin(RxDBLeaderElectionPlugin);\n    },\n    rxdb: true,\n    prototypes: {\n        RxCollection: (proto: any) => {\n            proto.syncFirestore = syncFirestore;\n        }\n    }\n};\n"],"mappings":"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"}