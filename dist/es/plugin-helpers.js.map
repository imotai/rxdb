{"version":3,"file":"plugin-helpers.js","names":["mergeMap","getPrimaryFieldOfPrimaryKey","fastUnsecureHash","flatClone","getFromMapOrThrow","requestIdleCallbackIfAvailable","VALIDATOR_CACHE_BY_VALIDATOR_KEY","Map","wrappedValidateStorageFactory","getValidator","validatorKey","has","set","VALIDATOR_CACHE","initValidator","schema","hash","JSON","stringify","validator","args","Object","assign","storage","createStorageInstance","params","instance","primaryPath","primaryKey","validatorCached","oldBulkWrite","bulkWrite","bind","documentWrites","context","errors","continueWrites","forEach","row","documentId","document","validationErrors","length","push","status","isError","writeRow","writePromise","Promise","resolve","error","success","then","writeResult","validationError","wrapRxStorageInstance","modifyToStorage","modifyFromStorage","modifyAttachmentFromStorage","v","toStorage","docData","fromStorage","errorFromStorage","ret","documentInDb","previous","wrappedInstance","databaseName","internals","cleanup","options","close","collectionName","count","remove","originalStorageInstance","useRows","all","map","undefined","promises","entries","k","v2","err","query","preparedQuery","queryResult","documents","doc","getAttachmentData","attachmentId","data","findDocumentsById","ids","deleted","findResult","key","getChangedDocumentsSince","limit","checkpoint","result","d","changeStream","pipe","eventBulk","events","event","documentData","previousDocumentData","ev","operation","eventId","endTime","startTime","isLocal","useEvents","id","conflictResultionTasks","task","input","assumedMasterState","newDocumentState","realMasterState","resolveConflictResultionTask","taskSolution","output","isEqual","useSolution"],"sources":["../../src/plugin-helpers.ts"],"sourcesContent":["import { mergeMap } from 'rxjs/operators';\nimport { getPrimaryFieldOfPrimaryKey } from './rx-schema-helper';\nimport { WrappedRxStorageInstance } from './rx-storage-helper';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxChangeEvent,\n    RxDocumentData,\n    RxDocumentDataById,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageInstanceCreationParams,\n    RxValidationError,\n    RxStorageWriteErrorConflict\n} from './types';\nimport {\n    fastUnsecureHash,\n    flatClone,\n    getFromMapOrThrow,\n    requestIdleCallbackIfAvailable\n} from './plugins/utils';\n\n\ntype WrappedStorageFunction = <Internals, InstanceCreationOptions>(\n    args: {\n        storage: RxStorage<Internals, InstanceCreationOptions>;\n    }\n) => RxStorage<Internals, InstanceCreationOptions>;\n\n/**\n * Returns the validation errors.\n * If document is fully valid, returns an empty array.\n */\ntype ValidatorFunction = (docData: RxDocumentData<any>) => RxValidationError[];\n\n/**\n * cache the validators by the schema-hash\n * so we can reuse them when multiple collections have the same schema\n */\nconst VALIDATOR_CACHE_BY_VALIDATOR_KEY: Map<string, Map<string, ValidatorFunction>> = new Map();\n\n/**\n * This factory is used in the validation plugins\n * so that we can reuse the basic storage wrapping code.\n */\nexport function wrappedValidateStorageFactory(\n    /**\n     * Returns a method that can be used to validate\n     * documents and throws when the document is not valid.\n     */\n    getValidator: (schema: RxJsonSchema<any>) => ValidatorFunction,\n    /**\n     * A string to identify the validation library.\n     */\n    validatorKey: string\n): WrappedStorageFunction {\n    if (!VALIDATOR_CACHE_BY_VALIDATOR_KEY.has(validatorKey)) {\n        VALIDATOR_CACHE_BY_VALIDATOR_KEY.set(validatorKey, new Map());\n    }\n    const VALIDATOR_CACHE = getFromMapOrThrow(VALIDATOR_CACHE_BY_VALIDATOR_KEY, validatorKey);\n\n    function initValidator(\n        schema: RxJsonSchema<any>\n    ): ValidatorFunction {\n        const hash = fastUnsecureHash(JSON.stringify(schema));\n        if (!VALIDATOR_CACHE.has(hash)) {\n            const validator = getValidator(schema);\n            VALIDATOR_CACHE.set(hash, validator);\n            return validator;\n        }\n        return getFromMapOrThrow(VALIDATOR_CACHE, hash);\n    }\n\n    return (args) => {\n        return Object.assign(\n            {},\n            args.storage,\n            {\n                async createStorageInstance<RxDocType>(\n                    params: RxStorageInstanceCreationParams<RxDocType, any>\n                ) {\n                    const instance = await args.storage.createStorageInstance(params);\n                    const primaryPath = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n\n                    /**\n                     * Lazy initialize the validator\n                     * to save initial page load performance.\n                     * Some libraries take really long to initialize the validator\n                     * from the schema.\n                     */\n                    let validatorCached: ValidatorFunction;\n                    requestIdleCallbackIfAvailable(() => validatorCached = initValidator(params.schema));\n\n                    const oldBulkWrite = instance.bulkWrite.bind(instance);\n                    instance.bulkWrite = (\n                        documentWrites: BulkWriteRow<RxDocType>[],\n                        context: string\n                    ) => {\n                        if (!validatorCached) {\n                            validatorCached = initValidator(params.schema);\n                        }\n                        const errors: RxStorageWriteError<RxDocType>[] = [];\n                        const continueWrites: typeof documentWrites = [];\n                        documentWrites.forEach(row => {\n                            const documentId: string = row.document[primaryPath] as any;\n                            const validationErrors = validatorCached(row.document);\n                            if (validationErrors.length > 0) {\n                                errors.push({\n                                    status: 422,\n                                    isError: true,\n                                    documentId,\n                                    writeRow: row,\n                                    validationErrors\n                                });\n                            } else {\n                                continueWrites.push(row);\n                            }\n                        });\n                        const writePromise: Promise<RxStorageBulkWriteResponse<RxDocType>> = continueWrites.length > 0 ? oldBulkWrite(continueWrites, context) : Promise.resolve({ error: {}, success: {} });\n                        return writePromise.then(writeResult => {\n                            errors.forEach(validationError => {\n                                writeResult.error[validationError.documentId] = validationError;\n                            });\n                            return writeResult;\n                        });\n                    };\n\n                    return instance;\n                }\n            }\n        );\n    };\n\n}\n\n\n\n/**\n * Used in plugins to easily modify all in- and outgoing\n * data of that storage instance.\n */\nexport function wrapRxStorageInstance<RxDocType>(\n    instance: RxStorageInstance<RxDocType, any, any>,\n    modifyToStorage: (docData: RxDocumentWriteData<RxDocType>) => Promise<RxDocumentData<any>> | RxDocumentData<any>,\n    modifyFromStorage: (docData: RxDocumentData<any>) => Promise<RxDocumentData<RxDocType>> | RxDocumentData<RxDocType>,\n    modifyAttachmentFromStorage: (attachmentData: string) => Promise<string> | string = (v) => v\n): WrappedRxStorageInstance<RxDocType, any, any> {\n    async function toStorage(docData: RxDocumentWriteData<RxDocType>): Promise<RxDocumentData<any>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyToStorage(docData);\n    }\n    async function fromStorage(docData: RxDocumentData<any> | null): Promise<RxDocumentData<RxDocType>> {\n        if (!docData) {\n            return docData;\n        }\n        return await modifyFromStorage(docData);\n    }\n    async function errorFromStorage(\n        error: RxStorageWriteError<any>\n    ): Promise<RxStorageWriteError<RxDocType>> {\n        const ret = flatClone(error);\n        ret.writeRow = flatClone(ret.writeRow);\n        if ((ret as RxStorageWriteErrorConflict<any>).documentInDb) {\n            (ret as RxStorageWriteErrorConflict<any>).documentInDb = await fromStorage((ret as RxStorageWriteErrorConflict<any>).documentInDb);\n        }\n        if (ret.writeRow.previous) {\n            ret.writeRow.previous = await fromStorage(ret.writeRow.previous);\n        }\n        ret.writeRow.document = await fromStorage(ret.writeRow.document);\n        return ret;\n    }\n\n\n    const wrappedInstance: WrappedRxStorageInstance<RxDocType, any, any> = {\n        databaseName: instance.databaseName,\n        internals: instance.internals,\n        cleanup: instance.cleanup.bind(instance),\n        options: instance.options,\n        close: instance.close.bind(instance),\n        schema: instance.schema,\n        collectionName: instance.collectionName,\n        count: instance.count.bind(instance),\n        remove: instance.remove.bind(instance),\n        originalStorageInstance: instance,\n        bulkWrite: async (\n            documentWrites: BulkWriteRow<RxDocType>[],\n            context: string\n        ) => {\n            const useRows: BulkWriteRow<any>[] = [];\n            await Promise.all(\n                documentWrites.map(async (row) => {\n                    const [previous, document] = await Promise.all([\n                        row.previous ? toStorage(row.previous) : undefined,\n                        toStorage(row.document)\n                    ]);\n                    useRows.push({ previous, document });\n                })\n            );\n\n            const writeResult = await instance.bulkWrite(useRows, context);\n            const ret: RxStorageBulkWriteResponse<RxDocType> = {\n                success: {},\n                error: {}\n            };\n            const promises: Promise<any>[] = [];\n            Object.entries(writeResult.success).forEach(([k, v]) => {\n                promises.push(\n                    fromStorage(v).then(v2 => ret.success[k] = v2)\n                );\n            });\n            Object.entries(writeResult.error).forEach(([k, error]) => {\n                promises.push(\n                    errorFromStorage(error).then(err => ret.error[k] = err)\n                );\n            });\n            await Promise.all(promises);\n            return ret;\n        },\n        query: (preparedQuery) => {\n            return instance.query(preparedQuery)\n                .then(queryResult => {\n                    return Promise.all(queryResult.documents.map(doc => fromStorage(doc)));\n                })\n                .then(documents => ({ documents: documents as any }));\n        },\n        getAttachmentData: async (\n            documentId: string,\n            attachmentId: string\n        ) => {\n            let data = await instance.getAttachmentData(documentId, attachmentId);\n            data = await modifyAttachmentFromStorage(data);\n            return data;\n        },\n        findDocumentsById: (ids, deleted) => {\n            return instance.findDocumentsById(ids, deleted)\n                .then(async (findResult) => {\n                    const ret: RxDocumentDataById<RxDocType> = {};\n                    await Promise.all(\n                        Object.entries(findResult)\n                            .map(async ([key, doc]) => {\n                                ret[key] = await fromStorage(doc);\n                            })\n                    );\n                    return ret;\n                });\n        },\n        getChangedDocumentsSince: (limit, checkpoint) => {\n            return instance.getChangedDocumentsSince(limit, checkpoint)\n                .then(async (result) => {\n                    return {\n                        checkpoint: result.checkpoint,\n                        documents: await Promise.all(\n                            result.documents.map(d => fromStorage(d))\n                        )\n                    };\n                });\n        },\n        changeStream: () => {\n            return instance.changeStream().pipe(\n                mergeMap(async (eventBulk) => {\n                    const useEvents = await Promise.all(\n                        eventBulk.events.map(async (event) => {\n                            const [\n                                documentData,\n                                previousDocumentData\n                            ] = await Promise.all([\n                                fromStorage(event.documentData),\n                                fromStorage(event.previousDocumentData)\n                            ]);\n                            const ev: RxChangeEvent<RxDocType> = {\n                                operation: event.operation,\n                                eventId: event.eventId,\n                                documentId: event.documentId,\n                                endTime: event.endTime,\n                                startTime: event.startTime,\n                                documentData: documentData as any,\n                                previousDocumentData: previousDocumentData as any,\n                                isLocal: false\n                            };\n                            return ev;\n                        })\n                    );\n                    const ret: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any> = {\n                        id: eventBulk.id,\n                        events: useEvents,\n                        checkpoint: eventBulk.checkpoint,\n                        context: eventBulk.context\n                    };\n                    return ret;\n                })\n            );\n        },\n        conflictResultionTasks: () => {\n            return instance.conflictResultionTasks().pipe(\n                mergeMap(async (task) => {\n                    const assumedMasterState = await fromStorage(task.input.assumedMasterState);\n                    const newDocumentState = await fromStorage(task.input.newDocumentState);\n                    const realMasterState = await fromStorage(task.input.realMasterState);\n                    return {\n                        id: task.id,\n                        context: task.context,\n                        input: {\n                            assumedMasterState,\n                            realMasterState,\n                            newDocumentState\n                        }\n                    };\n                })\n            );\n        },\n        resolveConflictResultionTask: (taskSolution) => {\n            if (taskSolution.output.isEqual) {\n                return instance.resolveConflictResultionTask(taskSolution);\n            }\n            const useSolution = {\n                id: taskSolution.id,\n                output: {\n                    isEqual: false,\n                    documentData: taskSolution.output.documentData\n                }\n            };\n            return instance.resolveConflictResultionTask(useSolution);\n        }\n    };\n\n    return wrappedInstance;\n}\n"],"mappings":"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"}