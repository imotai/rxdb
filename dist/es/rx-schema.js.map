{"version":3,"file":"rx-schema.js","names":["deepEqual","overwriteGetterForCaching","flatClone","isMaybeReadonlyArray","fastUnsecureHash","newRxError","runPluginHooks","defineGetterSetter","fillWithDefaultSettings","getComposedPrimaryKeyOfDocumentData","getFinalFields","getPrimaryFieldOfPrimaryKey","normalizeRxJsonSchema","overwritable","RxSchema","jsonSchema","indexes","getIndexes","primaryPath","primaryKey","finalFields","validateChange","dataBefore","dataAfter","forEach","fieldName","schema","fillObjectWithDefaults","obj","Object","entries","defaultValues","filter","k","hasOwnProperty","v","getDocumentPrototype","proto","getPrimaryOfDocumentData","documentData","version","values","properties","JSON","stringify","map","index","getPreviousVersions","c","Array","fill","createRxSchema","runPreCreateHooks","useJsonSchema","deepFreezeWhenDevMode","isInstanceOf","toTypedRxJsonSchema"],"sources":["../../src/rx-schema.ts"],"sourcesContent":["import deepEqual from 'fast-deep-equal';\n\nimport {\n    overwriteGetterForCaching,\n    flatClone,\n    isMaybeReadonlyArray,\n    fastUnsecureHash\n} from './plugins/utils';\nimport {\n    newRxError,\n} from './rx-error';\nimport {\n    runPluginHooks\n} from './hooks';\nimport {\n    defineGetterSetter\n} from './rx-document';\n\nimport type {\n    DeepMutable,\n    DeepReadonly, MaybeReadonly,\n    RxDocumentData,\n    RxJsonSchema,\n    StringKeys\n} from './types';\nimport {\n    fillWithDefaultSettings,\n    getComposedPrimaryKeyOfDocumentData,\n    getFinalFields,\n    getPrimaryFieldOfPrimaryKey,\n    normalizeRxJsonSchema\n} from './rx-schema-helper';\nimport { overwritable } from './overwritable';\n\nexport class RxSchema<RxDocType = any> {\n    public indexes: MaybeReadonly<string[]>[];\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\n    public finalFields: string[];\n\n    constructor(\n        public readonly jsonSchema: RxJsonSchema<RxDocumentData<RxDocType>>\n    ) {\n        this.indexes = getIndexes(this.jsonSchema);\n\n        // primary is always required\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.jsonSchema.primaryKey);\n\n        this.finalFields = getFinalFields(this.jsonSchema);\n    }\n\n    public get version(): number {\n        return this.jsonSchema.version;\n    }\n\n    public get defaultValues(): { [P in keyof RxDocType]: RxDocType[P] } {\n        const values = {} as { [P in keyof RxDocType]: RxDocType[P] };\n        Object\n            .entries(this.jsonSchema.properties)\n            .filter(([, v]) => (v as any).hasOwnProperty('default'))\n            .forEach(([k, v]) => (values as any)[k] = (v as any).default);\n        return overwriteGetterForCaching(\n            this,\n            'defaultValues',\n            values\n        );\n    }\n\n    /**\n     * @overrides itself on the first call\n     */\n    public get hash(): string {\n        return overwriteGetterForCaching(\n            this,\n            'hash',\n            fastUnsecureHash(JSON.stringify(this.jsonSchema))\n        );\n    }\n\n    /**\n     * checks if a given change on a document is allowed\n     * Ensures that:\n     * - final fields are not modified\n     * @throws {Error} if not valid\n     */\n    validateChange(dataBefore: any, dataAfter: any): void {\n        this.finalFields.forEach(fieldName => {\n            if (!deepEqual(dataBefore[fieldName], dataAfter[fieldName])) {\n                throw newRxError('DOC9', {\n                    dataBefore,\n                    dataAfter,\n                    fieldName,\n                    schema: this.jsonSchema\n                });\n            }\n        });\n    }\n\n    /**\n     * fills all unset fields with default-values if set\n     */\n    fillObjectWithDefaults(obj: any): any {\n        obj = flatClone(obj);\n        Object\n            .entries(this.defaultValues)\n            .filter(([k]) => !obj.hasOwnProperty(k) || typeof obj[k] === 'undefined')\n            .forEach(([k, v]) => obj[k] = v);\n        return obj;\n    }\n\n    /**\n     * creates the schema-based document-prototype,\n     * see RxCollection.getDocumentPrototype()\n     */\n    public getDocumentPrototype(): any {\n        const proto = {};\n        defineGetterSetter(this, proto, '');\n        overwriteGetterForCaching(\n            this,\n            'getDocumentPrototype',\n            () => proto\n        );\n        return proto;\n    }\n\n\n    getPrimaryOfDocumentData(\n        documentData: Partial<RxDocType>\n    ): string {\n        return getComposedPrimaryKeyOfDocumentData(\n            this.jsonSchema,\n            documentData\n        );\n    }\n}\n\nexport function getIndexes<RxDocType = any>(\n    jsonSchema: RxJsonSchema<RxDocType>\n): MaybeReadonly<string[]>[] {\n    return (jsonSchema.indexes || []).map(index => isMaybeReadonlyArray(index) ? index : [index]);\n}\n\n/**\n * array with previous version-numbers\n */\nexport function getPreviousVersions(schema: RxJsonSchema<any>): number[] {\n    const version = schema.version ? schema.version : 0;\n    let c = 0;\n    return new Array(version)\n        .fill(0)\n        .map(() => c++);\n}\n\nexport function createRxSchema<T>(\n    jsonSchema: RxJsonSchema<T>,\n    runPreCreateHooks = true\n): RxSchema<T> {\n    if (runPreCreateHooks) {\n        runPluginHooks('preCreateRxSchema', jsonSchema);\n    }\n\n    let useJsonSchema = fillWithDefaultSettings(jsonSchema);\n    useJsonSchema = normalizeRxJsonSchema(useJsonSchema);\n    overwritable.deepFreezeWhenDevMode(useJsonSchema);\n\n    const schema = new RxSchema(useJsonSchema);\n    runPluginHooks('createRxSchema', schema);\n    return schema;\n}\n\nexport function isInstanceOf(obj: any): boolean {\n    return obj instanceof RxSchema;\n}\n\n/**\n * Used as helper function the generate the document type out of the schema via typescript.\n * @link https://github.com/pubkey/rxdb/discussions/3467\n */\nexport function toTypedRxJsonSchema<T extends DeepReadonly<RxJsonSchema<any>>>(schema: T): DeepMutable<T> {\n    return schema as any;\n}\n"],"mappings":"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"}