{"version":3,"file":"checkpoint.js","names":["getComposedPrimaryKeyOfDocumentData","stackCheckpoints","createRevision","ensureNotFalsy","fastUnsecureHash","getDefaultRevision","getDefaultRxDocumentMeta","getFromObjectOrThrow","now","RX_REPLICATION_META_INSTANCE_SCHEMA","getLastCheckpointDoc","state","direction","checkpointDocId","isCheckpoint","itemId","replicationIdentifier","checkpointKey","input","metaInstance","findDocumentsById","checkpointResult","checkpointDoc","lastCheckpointDoc","data","undefined","setCheckpoint","checkpoint","previousCheckpointDoc","events","canceled","getValue","JSON","stringify","newDoc","id","_deleted","_attachments","_meta","_rev","lwt","identifier","bulkWrite","previous","document","result","success","error","status","documentInDb","getCheckpointKey","hash","forkInstance","databaseName","collectionName","join"],"sources":["../../../src/replication-protocol/checkpoint.ts"],"sourcesContent":["import { getComposedPrimaryKeyOfDocumentData } from '../rx-schema-helper';\nimport { stackCheckpoints } from '../rx-storage-helper';\nimport type {\n    RxDocumentData,\n    RxStorageInstanceReplicationInput,\n    RxStorageInstanceReplicationState,\n    RxStorageReplicationDirection,\n    RxStorageReplicationMeta\n} from '../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    fastUnsecureHash,\n    getDefaultRevision,\n    getDefaultRxDocumentMeta,\n    getFromObjectOrThrow,\n    now\n} from '../plugins/utils';\nimport { RX_REPLICATION_META_INSTANCE_SCHEMA } from './meta-instance';\n\nexport async function getLastCheckpointDoc<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection\n): Promise<undefined | CheckpointType> {\n    const checkpointDocId = getComposedPrimaryKeyOfDocumentData(\n        RX_REPLICATION_META_INSTANCE_SCHEMA,\n        {\n            isCheckpoint: '1',\n            itemId: direction,\n            replicationIdentifier: state.checkpointKey\n        }\n    );\n    const checkpointResult = await state.input.metaInstance.findDocumentsById(\n        [\n            checkpointDocId\n        ],\n        false\n    );\n\n    const checkpointDoc = checkpointResult[checkpointDocId];\n    state.lastCheckpointDoc[direction] = checkpointDoc;\n    if (checkpointDoc) {\n        return checkpointDoc.data;\n    } else {\n        return undefined;\n    }\n}\n\n\n/**\n * Sets the checkpoint,\n * automatically resolves conflicts that appear.\n */\nexport async function setCheckpoint<RxDocType, CheckpointType>(\n    state: RxStorageInstanceReplicationState<RxDocType>,\n    direction: RxStorageReplicationDirection,\n    checkpoint: CheckpointType\n) {\n    let previousCheckpointDoc = state.lastCheckpointDoc[direction];\n    if (\n        checkpoint &&\n        /**\n         * If the replication is already canceled,\n         * we do not write a checkpoint\n         * because that could mean we write a checkpoint\n         * for data that has been fetched from the master\n         * but not been written to the child.\n         */\n        !state.events.canceled.getValue() &&\n        /**\n         * Only write checkpoint if it is different from before\n         * to have less writes to the storage.\n         */\n        (\n            !previousCheckpointDoc ||\n            JSON.stringify(previousCheckpointDoc.data) !== JSON.stringify(checkpoint)\n        )\n    ) {\n        const newDoc: RxDocumentData<RxStorageReplicationMeta> = {\n            id: '',\n            isCheckpoint: '1',\n            itemId: direction,\n            replicationIdentifier: state.checkpointKey,\n            _deleted: false,\n            _attachments: {},\n            data: checkpoint,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision()\n        };\n        newDoc.id = getComposedPrimaryKeyOfDocumentData(\n            RX_REPLICATION_META_INSTANCE_SCHEMA,\n            newDoc\n        );\n        while (true) {\n            /**\n             * Instead of just storign the new checkpoint,\n             * we have to stack up the checkpoint with the previous one.\n             * This is required for plugins like the sharding RxStorage\n             * where the changeStream events only contain a Partial of the\n             * checkpoint.\n             */\n            if (previousCheckpointDoc) {\n                newDoc.data = stackCheckpoints([\n                    previousCheckpointDoc.data,\n                    newDoc.data\n                ]);\n            }\n            newDoc._meta.lwt = now();\n            newDoc._rev = createRevision(\n                state.input.identifier,\n                previousCheckpointDoc\n            );\n            const result = await state.input.metaInstance.bulkWrite([{\n                previous: previousCheckpointDoc,\n                document: newDoc\n            }], 'replication-set-checkpoint');\n\n            if (result.success[newDoc.id]) {\n                state.lastCheckpointDoc[direction] = getFromObjectOrThrow(\n                    result.success,\n                    newDoc.id\n                );\n                return;\n            } else {\n                const error = getFromObjectOrThrow(\n                    result.error,\n                    newDoc.id\n                );\n                if (error.status !== 409) {\n                    throw error;\n                } else {\n                    previousCheckpointDoc = ensureNotFalsy(error.documentInDb);\n                    newDoc._rev = createRevision(\n                        state.input.identifier,\n                        previousCheckpointDoc\n                    );\n                }\n            }\n        }\n    }\n}\n\nexport function getCheckpointKey<RxDocType>(\n    input: RxStorageInstanceReplicationInput<RxDocType>\n): string {\n    const hash = fastUnsecureHash([\n        input.identifier,\n        input.forkInstance.databaseName,\n        input.forkInstance.collectionName\n    ].join('||'));\n    return 'rx-storage-replication-' + hash;\n}\n"],"mappings":"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"}